step 1: downlad repo epel
 # EPEL Repo required to resolve PostGIS dependencies
 rpm -ivh http://dl.fedoraproject.org/pub/epel/7/x86_64/Packages/e/epel-release-7-11.noarch.rpm

step 2: download edb yum repo 

  rpm -ivh http://yum.enterprisedb.com/edbrepos/edb-repo-9.6-4.noarch.rpm

user:qs-investors
password: cc3ed73fcedcc6485eddae01ccd24778

sed -i "s/<username>/qs-investors/g"  /etc/yum.repos.d/edb.repo


sed -i "s/<password>/cc3ed73fcedcc6485eddae01ccd24778/g"  /etc/yum.repos.d/edb.repo


---------------------

[edbas96]
name=EnterpriseDB Advanced Server 9.6 $releasever - $basearch
baseurl=http://qs-investors:cc3ed73fcedcc6485eddae01ccd24778@yum.enterprisedb.com/9.6/redhat/rhel-$releasever-$basearch
enabled=1
gpgcheck=1
gpgkey=file:///etc/pki/rpm-gpg/ENTERPRISEDB-GPG-KEY


step 3: yum liste edb-as*
        yum list *bart*
        yum list *efm*

step 4 install

yum install edb-as96-server -y

 yum install efm21 -y


step 4: change owner of /var/data to enterprisedb


root: cd /var

chown -R enterprisedb:enterprisedb data

step 5: 

  link data dirctory /var/data to default : /var/lib/edb/as9.6/data

[root@pg-prd1 as9.6]# rm -rf /var/lib/edb/as9.6/data
[root@pg-prd1 as9.6]# ls
backups

-- make link :    
  ln -s /var/data/ /var/lib/edb/as9.6/data


[root@pg-prd1 as9.6]# ln -s /var/data/ /var/lib/edb/as9.6/data
[root@pg-prd1 as9.6]# ls
backups  data
[root@pg-prd1 as9.6]# ls -ltr
total 0
drwx------. 2 enterprisedb enterprisedb  6 Aug 30 02:33 backups
lrwxrwxrwx. 1 root         root         10 Nov  8 11:47 data -> /var/data/
[root@pg-prd1 as9.6]#

step 6: initdb  ( postgres compatible )

enterprisedb:
 /usr/edb/as9.6/bin/initdb --no-redwood-compat --encoding=UTF8 -U postgres -D /var/lib/edb/as9.6/data


[root@pg-prd1 ~]# su - enterprisedb
Last login: Wed Nov  8 10:24:31 EST 2017 from qsi-nydc-xd003.qsi.local on pts/0

[enterprisedb@pg-prd1 ~]$ /usr/edb/as9.6/bin/initdb --no-redwood-compat --encoding=UTF8 -U postgres -D /var/lib/edb/as9.6/data
The files belonging to this database system will be owned by user "enterprisedb".
This user must also own the server process.

The database cluster will be initialized with locale "en_US.UTF-8".
The default text search configuration will be set to "english".

Data page checksums are disabled.

fixing permissions on existing directory /var/lib/edb/as9.6/data ... ok
creating subdirectories ... ok
selecting default max_connections ... 100
selecting default shared_buffers ... 128MB
selecting dynamic shared memory implementation ... posix
creating configuration files ... ok
running bootstrap script ... ok
performing post-bootstrap initialization ... ok
loading edb contrib modules ...
dbms_aqadm_public.sql ok
dbms_aqadm.plb ok
dbms_aq_public.sql ok
dbms_aq.plb ok
edb_bulkload.sql ok
edb_gen.sql ok
edb_objects.sql ok
waitstates.sql ok
installing extension edb_dblink_libpq ... ok
installing extension edb_dblink_oci ... ok
installing extension pldbgapi ... ok
snap_tables.sql ok
snap_functions.sql ok
dblink_ora.sql ok
edb_infinitecache.sql ok
sys_stats.sql ok
finalizing initial databases ... ok
syncing data to disk ... ok

WARNING: enabling "trust" authentication for local connections
You can change this by editing pg_hba.conf or using the option -A, or
--auth-local and --auth-host, the next time you run initdb.

Success. You can now start the database server using:

    /usr/edb/as9.6/bin/pg_ctl -D /var/lib/edb/as9.6/data -l logfile start

[enterprisedb@pg-prd1 ~]$
[enterprisedb@pg-prd1 ~]$


step 7: enable edb-as-9.6

[root@pg-prd1 ~]# systemctl enable edb-as-9.6
Created symlink from /etc/systemd/system/multi-user.target.wants/edb-as-9.6.service to /usr/lib/systemd/system/edb-as-9.6.service.
[root@pg-prd1 ~]#

step 8: start edb-as-9.6

  systemctl start edb-as-9.6 

  systemctl status edb-as-9.6

  ps -ef | grep edb 
 
/usr/edb/as9.6/bin/edb-postmaster -D /var/lib/edb/as9.6/data

[enterprisedb@pg-prd1 data]$ ps -ef | grep postgres
enterpr+ 18660 24710  0 Nov15 ?        00:00:10 postgres: wal sender process repuser 10.81.10.226[51764] streaming 0/555CFE38
enterpr+ 20161 24710  0 09:20 ?        00:00:00 postgres: postgres postgres 127.0.0.1[58354] idle
enterpr+ 22213  5026  0 09:29 pts/3    00:00:00 grep --color=auto postgres
enterpr+ 24710     1  0 Nov14 ?        00:01:47 /usr/edb/as9.6/bin/edb-postgres -D /var/lib/edb/as9.6/data
enterpr+ 24711 24710  0 Nov14 ?        00:00:01 postgres: logger process
enterpr+ 24713 24710  0 Nov14 ?        00:00:32 postgres: checkpointer process
enterpr+ 24714 24710  0 Nov14 ?        00:00:02 postgres: writer process
enterpr+ 24715 24710  0 Nov14 ?        00:00:06 postgres: wal writer process
enterpr+ 24716 24710  0 Nov14 ?        00:00:08 postgres: autovacuum launcher process
enterpr+ 24717 24710  0 Nov14 ?        00:00:11 postgres: archiver process   failed on 000000010000000000000001
enterpr+ 24718 24710  0 Nov14 ?        00:01:35 postgres: stats collector process
enterpr+ 24720 24710  0 Nov14 ?        00:00:01 postgres: bgworker: dbms_aq launcher
enterpr+ 24888 24710  0 Nov14 ?        00:00:12 postgres: wal sender process repuser 10.91.10.227[53596] streaming 0/555CFE38
enterpr+ 29404 24710  0 Nov14 ?        00:09:05 postgres: postgres postgres 10.91.10.229[36896] idle


step 9: connect to postgres ( postgrs compatible)

-- user is postgres
   db is postgres 

[enterprisedb@pg-prd1 ~]$ psql postgres -U postgres
psql.bin (9.6.5.10)
Type "help" for help.

postgres=#


step 10: check user enterpirsedb env

[enterprisedb@pg-prd1 ~]$ pwd
/home/enterprisedb
[enterprisedb@pg-prd1 ~]$ ls -la
total 24
drwx------. 6 enterprisedb domain users  177 Nov  8 12:10 .
drwxr-xr-x. 6 root         root           78 Oct 30 13:36 ..
-rw-------. 1 enterprisedb domain users 1056 Nov  8 12:06 .bash_history
-rw-------. 1 enterprisedb domain users   18 Oct 30 12:03 .bash_logout
-rw-------. 1 enterprisedb domain users  193 Oct 30 12:03 .bash_profile
-rw-------. 1 enterprisedb domain users  231 Oct 30 12:03 .bashrc
drwxr-xr-x. 3 enterprisedb domain users   18 Oct 30 12:05 .cache
drwxr-xr-x. 3 enterprisedb domain users   18 Oct 30 12:05 .config
drwx------. 4 enterprisedb domain users   39 Oct 30 12:03 .mozilla
-rw-------. 1 enterprisedb domain users    3 Nov  8 12:06 .psql_history
drwx------. 2 enterprisedb domain users   25 Nov  3 08:29 .ssh
-rw-------. 1 enterprisedb domain users 1306 Nov  8 12:10 .viminfo
[enterprisedb@pg-prd1 ~]$

vi .bash_profile


PGDATA=/var/lib/edb/as9.6/data
LD_LIBRARY_PATH=/usr/edb/as9.6/lib
PATH=$PATH:$HOME/.local/bin:$HOME/bin:/usr/edb/as9.6/bin
export PGDATA
export LD_LIBRARY_PATH
export PATH





step 11 update postgresql.conf file 

-- check free memory 

[enterprisedb@pg-prd1 data]$ cat  /proc/meminfo| grep MemTotal
MemTotal:       49292040 kB


[enterprisedb@pg-prd1 data]$ free -h
              total        used        free      shared  buff/cache   available
Mem:            47G        563M         45G        218M        1.4G         45G
Swap:          3.9G          0B        3.9G

http://pgtune.leopard.in.ua/
-- get suggestion:

input: mem:48GB

# DB Version: 9.6
# OS Type: linux
# DB Type: oltp
# Total Memory (RAM): 48 GB
# Number of Connections: 300

max_connections = 300
shared_buffers = 12GB
effective_cache_size = 36GB
work_mem = 41943kB
maintenance_work_mem = 2GB
min_wal_size = 2GB
max_wal_size = 4GB
checkpoint_completion_target = 0.9
wal_buffers = 16MB
default_statistics_target = 100
------------------------------

cat >>$PGDATA/postgresql.conf <<EOF

max_connections = 300
shared_buffers = 12GB
effective_cache_size = 36GB
work_mem = 40MB
maintenance_work_mem = 2GB
checkpoint_completion_target = 0.9
wal_buffers = 16MB
default_statistics_target = 100

hot_standby = on
hot_standby_feedback = on
max_wal_senders = 6
wal_level = replica # hot_standby is depreciated 
archive_mode = on
archive_command = '/bin/rue'
logging_collector = on
log_lock_waits = on
log_temp_files = 0
log_checkpoints = on
log_autovacuum_min_duration = 0
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d'
min_wal_size = 512MB
max_wal_size = 5GB
wal_keep_segments = 64
edb_dynatune = 100

EOF

step 12 craete  rep user 

 create user repuser with replication password 'reppass';

-- create /home/enterprisedb/.pgpass

 vi .pgpass

localhost:5444:replication:repuser:reppass
10.91.10.226:5444:replication:repuser:reppass
10.91.10.227:5444:replication:repuser:reppass
10.81.10.226:5444:replication:repuser:reppass

chmod 600 .pgpass


-- edit pg_hba.conf

host    replication     repuser         10.91.10.226/32          md5
host    replication     repuser         10.91.10.227/32          md5
host    replication     repuser         10.81.10.226/32          md5


-- restart db 

systemctl stop edb-as-9.6
systemctl start edb-as-9.6



[enterprisedb@pg-prd1 ~]$ psql postgres -U postgres
psql.bin (9.6.5.10)
Type "help" for help.

postgres=# \l
                                     List of databases
   Name    |  Owner   | Encoding |   Collate   |    Ctype    | ICU |   Access privileges
-----------+----------+----------+-------------+-------------+-----+-----------------------
 postgres  | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 |     |
 template0 | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 |     | =c/postgres          +
           |          |          |             |             |     | postgres=CTc/postgres
 template1 | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 |     | =c/postgres          +
           |          |          |             |             |     | postgres=CTc/postgres
(3 rows)


step 13: standby setup 

  13.1 install as96 on pg-prd2 at 10.91.10.227 with root 
  13.2: change owner of /var/data to enterprisedb
            root: cd /var
            chown -R enterprisedb:enterprisedb data
            chmod 700 data

  13.3 make link /var/data/ to /var/lib/edb/as9.6/data 

root@pg-prd2 as9.6]# rm -rf /var/lib/edb/as9.6/data
[root@pg-prd2 as9.6]# ls
backups

-- make link :    
  ln -s /var/data/ /var/lib/edb/as9.6/data

[root@pg-prd1 as9.6]# ln -s /var/data/ /var/lib/edb/as9.6/data

  13.4: create /home/enterprisedb/.pgpass 

localhost:5444:replication:repuser:reppass
10.91.10.226:5444:replication:repuser:reppass
10.91.10.227:5444:replication:repuser:reppass
10.81.10.226:5444:replication:repuser:reppass

  13.5: set env  /home/enterprisedb/.bash_profile 
      

PGDATA=/var/lib/edb/as9.6/data
LD_LIBRARY_PATH=/usr/edb/as9.6/lib
PATH=$PATH:$HOME/.local/bin:$HOME/bin:/usr/edb/as9.6/bin
export PGDATA
export LD_LIBRARY_PATH
export PATH
  
 13.6 use pg_basebackup to get database from pg-prd1 on pg-prd2
   
   pg-prd1: root: systemctl stop firewalld


   pg-prd2:
     /usr/edb/as9.6/bin/pg_basebackup --host=10.91.10.226 --user=repuser --pgdata=$PGDATA  --write-recovery-conf --xlog-method=stream  --progress --verbose

[enterprisedb@pg-prd2 ~]$  /usr/edb/as9.6/bin/pg_basebackup --host=10.91.10.226 --user=repuser --pgdata=$PGDATA  --write-recovery-conf --xlog-method=stream  --progress --verbose
pg_basebackup: initiating base backup, waiting for checkpoint to complete
pg_basebackup: checkpoint completed
transaction log start point: 0/2000028 on timeline 1
pg_basebackup: starting background WAL receiver
27517/27517 kB (100%), 1/1 tablespace
transaction log end point: 0/20000F8
pg_basebackup: waiting for background process to finish streaming ...
pg_basebackup: base backup completed
[enterprisedb@pg-prd2 ~]$

  13.7: check $/PGDATA/recovery.conf
   standby_mode = 'on'
primary_conninfo = 'user=repuser host=10.91.10.226 port=5444 sslmode=prefer sslcompression=1 krbsrvname=postgres target_session_attrs=any'

  13.8: start standby at pg-prd2

    systemctl start edb-as-9.6
    
    -- reset up replication from DR ( get db from standby pg-prd2 at 10.91.10.227)
    
  [enterprisedb@pg-dr data]$ /usr/edb/as9.6/bin/pg_basebackup --host=10.91.10.227 --user=repuser --pgdata=$PGDATA  --write-recovery-conf --xlog-method=stream  --progress --verbose
pg_basebackup: initiating base backup, waiting for checkpoint to complete
pg_basebackup: checkpoint completed
transaction log start point: 0/5020BB8 on timeline 1
pg_basebackup: starting background WAL receiver
36830/36830 kB (100%), 1/1 tablespace
transaction log end point: 0/5020C98
pg_basebackup: waiting for background process to finish streaming ...
pg_basebackup: base backup completed
[enterprisedb@pg-dr data]$


  13.9: check stanby db 
   [enterprisedb@pg-prd2 ~]$ psql postgres -U postgres
psql.bin (9.6.5.10)
Type "help" for help.


postgres=# select pg_is_in_recovery();
 pg_is_in_recovery
-------------------
 t
(1 row)

step 14: change password for db superuser postgres

pg-prd1:
   postgres=# alter role postgres password 'edb';

=====================================================
instsall pem on server pem-prd (10.91.

 ./pem-server-7.0.0-1-linux-x64.run --extract-dependents /root/pemdeped

cd /root/pemdeped

[root@pem-prd pemdeped]# ./edb-languagepack-10-2-linux-x64.run
Language Selection

Please select the installation language
[1] English - English
Please choose an option [1] :
\----------------------------------------------------------------------------
Welcome to the Language Pack Setup Wizard.

----------------------------------------------------------------------------
Setup is now ready to begin installing on your computer.

/opt/edb/languagepack-10

Do you want to continue? [Y/n]: y

Do you want to continue? [Y/n]:

----------------------------------------------------------------------------
Please wait while Setup installs Language Pack on your computer.

 Installing Language Pack
 0% ______________ 50% ______________ 100%
 #########################################

----------------------------------------------------------------------------
EnterpriseDB is the leading provider of value-added products and services for
the Postgres community.

Please visit our website at www.enterprisedb.com

[root@pem-prd pemdeped]# ./pem-httpd-2.4.25-1-linux-x64.run
----------------------------------------------------------------------------
Welcome to the PEM-HTTPD Setup Wizard.

----------------------------------------------------------------------------
Please specify the directory where PEM-HTTPD will be installed.

Installation Directory [/opt/edb/pem/httpd]:

----------------------------------------------------------------------------
Apache Server Details

Please specify a port on which Apache will run

Apache Port [8080]:

----------------------------------------------------------------------------
Setup is now ready to begin installing PEM-HTTPD on your computer.

Do you want to continue? [Y/n]:

----------------------------------------------------------------------------
Please wait while Setup installs PEM-HTTPD on your computer.

 Installing PEM-HTTPD
 0% ______________ 50% ______________ 100%
 #########################################

----------------------------------------------------------------------------
EnterpriseDB is the leading provider of value-added products and services for
the Postgres community.

Please visit our website at www.enterprisedb.com



[root@pem-prd pemdeped]# ./postgresql-9.6.3-2-linux-x64.run
----------------------------------------------------------------------------
Welcome to the PostgreSQL Setup Wizard.

----------------------------------------------------------------------------
Please specify the directory where PostgreSQL will be installed.

Installation Directory [/opt/PostgreSQL/9.6]:

----------------------------------------------------------------------------
Please select a directory under which to store your data.

Data Directory [/opt/PostgreSQL/9.6/data]:

----------------------------------------------------------------------------
Please provide a password for the database superuser (postgres). A locked Unix
user account (postgres) will be created if not present.

Password :postgres
Retype password :postgres
----------------------------------------------------------------------------
Please select the port number the server should listen on.

Port [5432]:

----------------------------------------------------------------------------
Advanced Options

Select the locale to be used by the new database cluster.

Locale

[1] [Default locale]
[2] aa_DJ
.......
[772] zu_ZA.iso88591
[773] zu_ZA.utf8
Please choose an option [1] :

----------------------------------------------------------------------------
Setup is now ready to begin installing PostgreSQL on your computer.

Do you want to continue? [Y/n]:

----------------------------------------------------------------------------
Please wait while Setup installs PostgreSQL on your computer.

 Installing
 0% ______________ 50% ______________ 100%
 #########################################

----------------------------------------------------------------------------
Setup has finished installing PostgreSQL on your computer.

-- install pem 
[root@pem-prd ~]# ./pem-server-7.0.0-1-linux-x64.run
----------------------------------------------------------------------------
Welcome to the Postgres Enterprise Manager (PEM) Server Setup Wizard.

----------------------------------------------------------------------------
Please read the following License Agreement. You must accept the terms of this
agreement before continuing with the installation.

Press [Enter] to continue:
Limited Use Software License Agreement
Version 2.9

......

Press [Enter] to continue:

Do you accept this license? [y/n]:

Do you accept this license? [y/n]: y

----------------------------------------------------------------------------
EnterpriseDB User Account Information

Please enter the email address and password for your enterprisedb.com user
account.



Email address []: guorong.zhang@enterprisedb.com

Password :

----------------------------------------------------------------------------
Installation Directory

Please select a directory for the PEM server installation.

Installation Directory [/opt/edb/pem]:



Show &advanced options [y/N]: y


----------------------------------------------------------------------------
Advanced options

Select installation type

[1] Web Services and Database
[2] Web Services
[3] Database
Please choose an option [1] :

----------------------------------------------------------------------------
Database Server Selection

Select the database server.

The database servers below may be used by Postgres Enterprise Manager for its data store.

[1] PostgreSQL 9.6 on Port 5432
[2] Other Database Server
Please choose an option [1] : 1

----------------------------------------------------------------------------
Database Server Installation Details

Please specify user and password for the local server - 'PostgreSQL 9.6'
installation running on port 5432.

User [postgres]:

Password :

----------------------------------------------------------------------------
Network Details

Please enter the CIDR formatted network address range that agents will connect
to the server from, to be added to the server's pg_hba.conf file. For example,
192.168.1.0/24.

Network address [127.0.0.1/32]:

----------------------------------------------------------------------------
Agent Details.

Please specify a description for the agent.

Description. [Postgres Enterprise Manager Host]:

Agent certificate path [/root/.pem]:

----------------------------------------------------------------------------
Setup is now ready to begin installing the PEM server on your computer.

Do you want to continue? [Y/n]:

----------------------------------------------------------------------------
Please wait while Setup installs the PEM server on your computer.

 Installing
 0% ______________ 50% ______________ 100%
 #########################################

Info: Configured the webservice for Postgres Enterprise Manager (PEM) Server on
port '8443'.
Created and configured the 'pem' database.
Press [Enter] to continue:
----------------------------------------------------------------------------
EnterpriseDB is the leading provider of value-added products and services for
the Postgres community.

Please visit our website at www.enterprisedb.com

You have mail in /var/spool/mail/root
[root@pem-prd ~]#

[root@pem-prd ~]# ps -ef | pem
bash: pem: command not found...
[root@pem-prd ~]# ps -ef | grep pem
avahi      783     1  0 Oct20 ?        00:00:00 avahi-daemon: running [pem-prd.local]
root     20780     1  0 16:06 ?        00:00:00 /opt/edb/pem/agent/bin/pemagent -c /opt/edb/pem/agent/etc/agent.cfg
root     20781 20780  0 16:06 ?        00:00:01 /opt/edb/pem/agent/bin/pemworker -c /opt/edb/pem/agent/etc/agent.cfg --pid 20780
postgres 20793 20610  0 16:06 ?        00:00:01 postgres: agent1 pem 127.0.0.1(54800) idle
postgres 20794 20610  1 16:06 ?        00:00:17 postgres: agent1 pem 127.0.0.1(54802) SELECT
postgres 20796 20610  0 16:06 ?        00:00:00 postgres: agent1 pem 127.0.0.1(54804) idle
postgres 20797 20610  0 16:06 ?        00:00:00 postgres: agent1 pem 127.0.0.1(54806) idle
postgres 20798 20610  0 16:06 ?        00:00:00 postgres: agent1 pem 127.0.0.1(54808) idle
root     20834     1  0 16:07 ?        00:00:00 /opt/edb/pem/httpd/apache/bin/httpd -k start -f /opt/edb/pem/httpd/apache/conf/httpd.conf
pem      20835 20834  0 16:07 ?        00:00:00 EDBPEM                              -k start -f /opt/edb/pem/httpd/apache/conf/httpd.conf
daemon   20836 20834  0 16:07 ?        00:00:00 /opt/edb/pem/httpd/apache/bin/httpd -k start -f /opt/edb/pem/httpd/apache/conf/httpd.conf
daemon   20837 20834  0 16:07 ?        00:00:00 /opt/edb/pem/httpd/apache/bin/httpd -k start -f /opt/edb/pem/httpd/apache/conf/httpd.conf
daemon   20838 20834  0 16:07 ?        00:00:00 /opt/edb/pem/httpd/apache/bin/httpd -k start -f /opt/edb/pem/httpd/apache/conf/httpd.conf
root     24178 18003  0 16:30 pts/0    00:00:00 grep --color=auto pem

-- check db on pem server

 ps -ef | grep postgres


 /opt/PostgreSQL/9.6/bin/postgres -D /opt/PostgreSQL/9.6/data

use firefox ( add exception) 
-- also firewall is needed to disabled 

  systemctl stop firewalld 


https://10.91.10.229:8443/pem 
 


==================================
setup efm 
-- check java version ( must be over 1.7) 
[enterprisedb@pg-prd1 ~]$ java -version
openjdk version "1.8.0_151"
OpenJDK Runtime Environment (build 1.8.0_151-b12)
OpenJDK 64-Bit Server VM (build 25.151-b12, mixed mode)
  need efm license number: ??????

step 1: generate encypyted pass for db user postgres ( pass: edb)

[root@pem-prd efm-2.1]# /usr/efm-2.1/bin/efm encrypt efm
This utility will generate an encrypted password for you to place in your
EFM cluster property file.
Please enter the password and hit enter:edb

Please enter the password again to confirm:edb

The encrypted password is: 22a85432353cbff0bb8b4cab6cd53045

Please paste this into your cluster properties file.
        db.password.encrypted=22a85432353cbff0bb8b4cab6cd53045
[root@pem-prd efm-2.1]#


virtualIp=10.91.10.225
virtualIp.interface=eth0:0 ( should be:ens192:0)
virtualIp.netmask=225.225.225.0

  
-- test vip 
[root@pg-prd2 efm-2.1]# /bin/ping -q -c3 -w5 10.91.10.225
PING 10.91.10.225 (10.91.10.225) 56(84) bytes of data.

--- 10.91.10.225 ping statistics ---
4 packets transmitted, 0 received, +4 errors, 100% packet loss, time 2999ms
pipe 4
[root@pg-prd2 efm-2.1]#

-- assign vip on master

/usr/efm-2.1/bin/efm_address assign eth0:0 10.91.10.225 225.225.225.0 

[root@pg-prd2 bin]# /usr/efm-2.1/bin/efm_address assign eth0:0 10.91.10.225 225.225.225.0
SIOCSIFADDR: No such device
eth0:0: ERROR while getting interface flags: No such device
SIOCSIFNETMASK: No such device
eth0:0: ERROR while getting interface flags: No such device

-- try user interface ens192 ( got it by "ifconfig")

[root@pg-prd2 bin]# /usr/efm-2.1/bin/efm_address assign ens192:0 10.91.10.225 255.255.255.0

-- hang over there --> close putty --> re ssh with putty and does not work 
  ---> putty to pg-prd2 and then ssh to pg-prd1( 10.91.10.226) --> OK ????


-- check vip 

[enterprisedb@pg-prd1 ~]$ ifconfig
ens192: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500
        inet 10.91.10.226  netmask 255.255.255.0  broadcast 10.91.10.255
        inet6 fe80::250:56ff:fea6:4a7b  prefixlen 64  scopeid 0x20<link>
        ether 00:50:56:a6:4a:7b  txqueuelen 1000  (Ethernet)
        RX packets 2838103  bytes 302231696 (288.2 MiB)
        RX errors 0  dropped 591531  overruns 0  frame 0
        TX packets 109120  bytes 107066039 (102.1 MiB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

ens192:0: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500
        inet 10.91.10.225  netmask 255.255.255.0  broadcast 10.91.10.255
        ether 00:50:56:a6:4a:7b  txqueuelen 1000  (Ethernet)

)

lo: flags=73<UP,LOOPBACK,RUNNING>  mtu 65536
        inet 127.0.0.1  netmask 255.0.0.0
        inet6 ::1  prefixlen 128  scopeid 0x10<host>
        loop  txqueuelen 1  (Local Loopback)
        RX packets 3121  bytes 935070 (913.1 KiB)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 3121  bytes 935070 (913.1 KiB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

-- check vip 

[root@pg-prd1 ~]# /bin/ping -q -c3 -w5 10.91.10.225
PING 10.91.10.225 (10.91.10.225) 56(84) bytes of data.

--- 10.91.10.225 ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 1999ms
rtt min/avg/max/mdev = 0.032/0.037/0.044/0.007 ms
[root@pg-prd1 ~]#


-- good !!!

-- release vip

/usr/efm-2.1/bin/efm_address release  ens192:0 

[root@pg-prd1 ~]# /usr/efm-2.1/bin/efm_address release  ens192:0
[root@pg-prd1 ~]# ifconfig
ens192: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500
        inet 10.91.10.226  netmask 255.255.255.0  broadcast 10.91.10.255
        inet6 fe80::250:56ff:fea6:4a7b  prefixlen 64  scopeid 0x20<link>
        ether 00:50:56:a6:4a:7b  txqueuelen 1000  (Ethernet)
        RX packets 2841257  bytes 302479542 (288.4 MiB)
        RX errors 0  dropped 592141  overruns 0  frame 0
        TX packets 109586  bytes 107110981 (102.1 MiB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

lo: flags=73<UP,LOOPBACK,RUNNING>  mtu 65536
        inet 127.0.0.1  netmask 255.0.0.0
        inet6 ::1  prefixlen 128  scopeid 0x10<host>
        loop  txqueuelen 1  (Local Loopback)
        RX packets 3302  bytes 971286 (948.5 KiB)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 3302  bytes 971286 (948.5 KiB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

-- virtualIp.interface should be: ens192

efmn.nodes file:

10.91.10.226:7809
10.91.10.227:7809
10.91.10.229:7809

pg_hba.conf
host    all     enterprisedb         10.91.10.226/32          md5
host    all     enterprisedb         10.91.10.227/32          md5
host    all     postgres             10.91.10.229/32          md5


==================================================================
1: slow down installation due to copy/paste is disabled 
2: PEM server:
   both in pem-prd and pem-dr ?
   pem production key ??
   QSI account in edb info: email: company_name@enterprisedb.com/password
   pem webclient : firewall ( currently firewll is disabled) 
3: EFM
   license key: ?
   VirtualIp:interface: ??
   virtualIpmask: 255.255.255.0 ?
   pg-dr will not join EFM --> what if failover happend on pg-dr ?
4: Bart
   which server will be installed ? which database will be backedup by bart ?( prd from primary node or standby node? pem-prd?)
   NFS : shared file system ( pg-prd1 and pg-prd2: indentical os user "enterprisedb") ok 
         pem-prd os user"postgres" -- cannot use centralized backup 
   
   ============================
   
   HOW TO START AGENT

   systemctl START  efm-2.1.service 

    ROOT: /usr/efm-2.1/bin/
    or 
        /usr/efm-2.1/bin/runefm.sh  start efm   # IF "systemctl START  efm-2.1.service" CANNOT START  

HOW TO STOP AGENT AND CLUSTER :

  Stop agent on any node and just stop local node's agent
 systemctl stop efm-2.1.service 
   -- service will refresh file efm.nodes
   
  Stop  cluster(EFM) on any node ( will stop agent across all of node)

        /usr/efm-2.1/bin/efm stop-cluster efm

  Stop local agent
  /usr/efm-2.1/bin/runefm.sh  stop efm

  ** Stop cluster  by “efm stop-cluster efm” will not edit file /etc/efm-2.1/efm.nodes
  -- check status 
  
/usr/efm-2.1/bin/efm cluster-status efm

[root@pg-prd2 efm-2.1]# cat startup-efm.log
[ 11/9/17 10:09:57 AM ] Starting agent.
[ 11/9/17 10:09:57 AM ] Continuing startup in standby mode.
[ 11/9/17 10:09:57 AM ] Could not read the trigger file location from recovery.conf in directory specified in properties file. See log for more details.
[root@pg-prd2 efm-2.1]#

trigger_file='/var/lib/edb/as9.6/data/tigger_file'

-- add standby node to efm 

     /usr/efm-2.1/bin/efm add-node efm ip_name 
      or  /usr/efm-2.1/bin/efm allow-node efm  ip_name
      
db.port in wintness must be same as primary db

-- test vip 10.91.10.225 from pem-prd at 10.91.10.229

[enterprisedb@pem-prd ~]$ ssh 10.91.10.225
The authenticity of host '10.91.10.225 (10.91.10.225)' can't be established.
ECDSA key fingerprint is SHA256:fuIqwb05GobZCz6OSEK3Ie7IWL6N82MS4huuxoZcfBw.
ECDSA key fingerprint is MD5:c5:f1:bd:8c:4c:5b:fe:c6:ff:29:95:f6:83:0c:2e:3c.
Are you sure you want to continue connecting (yes/no)? yes
Warning: Permanently added '10.91.10.225' (ECDSA) to the list of known hosts.
#############################################################
#                     Welcome to QSI                        #
#       All connections are monitored and recored           #
# Disconnect IMMEDIATELY if you are not an authorized user! #
#############################################################

enterprisedb@10.91.10.225's password:
Last login: Thu Nov  9 10:49:43 2017 from pg-prd2.qsi.local
#############################################################
#                     Welcome to QSI                        #
#       All connections are monitored and recored           #
# Disconnect IMMEDIATELY if you are not an authorized user! #
#############################################################

[enterprisedb@pg-prd1 ~]$ ifconfig
ens192: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500
        inet 10.91.10.226  netmask 255.255.255.0  broadcast 10.91.10.255
        inet6 fe80::250:56ff:fea6:4a7b  prefixlen 64  scopeid 0x20<link>
        ether 00:50:56:a6:4a:7b  txqueuelen 1000  (Ethernet)
        RX packets 3152405  bytes 327505833 (312.3 MiB)
        RX errors 0  dropped 650926  overruns 0  frame 0
        TX packets 149883  bytes 111050113 (105.9 MiB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

ens192:0: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500
        inet 10.91.10.225  netmask 255.0.0.0  broadcast 10.255.255.255
        ether 00:50:56:a6:4a:7b  txqueuelen 1000  (Ethernet)

lo: flags=73<UP,LOOPBACK,RUNNING>  mtu 65536
        inet 127.0.0.1  netmask 255.0.0.0
        inet6 ::1  prefixlen 128  scopeid 0x10<host>
        loop  txqueuelen 1  (Local Loopback)
        RX packets 25461  bytes 6571177 (6.2 MiB)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 25461  bytes 6571177 (6.2 MiB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
        
        
        -- efm pro-check
       [root@pg-prd1 ~]# /usr/efm-2.1/bin/efm prop-check efm
Agents:
        10.91.10.226:7809
Binding address: 10.91.10.226
I am witness node: false
Cluster name: efm
User emails: [guorong.zhang@enterprisedb.com]
Notification script: null
VIP: 10.91.10.225
VIP interface: ens192:0
VIP netmask: 255.255.255.0
Automatic failover set to: false

Network interfaces:
ens192
        fe80:0:0:0:250:56ff:fea6:4a7b%ens192
        10.91.10.225
        10.91.10.226

        ens192:0
                10.91.10.225
lo
        0:0:0:0:0:0:0:1%lo
        127.0.0.1
        
 -- check efm status 
 [root@pg-prd1 ~]# /usr/efm-2.1/bin/efm cluster-status efm
Cluster Status: efm
VIP: 10.91.10.225
Automatic failover is disabled.

        Agent Type  Address              Agent  DB       Info
        --------------------------------------------------------------
        Standby     10.91.10.227         UP     UP
        Master      10.91.10.226         UP     UP
        Witness     10.91.10.229         UP     N/A

Allowed node host list:
        10.91.10.226 10.91.10.227 10.91.10.229

Membership coordinator: 10.91.10.226

Standby priority host list:
        10.91.10.227

Promote Status:

        DB Type     Address              XLog Loc         Info
        --------------------------------------------------------------
        Master      10.91.10.226         0/B177F18
        Standby     10.91.10.227         0/B177F18

        Standby database(s) in sync with master. It is safe to promote.

        

==================================================
insall pemagent

yum install pem-agent -y

--edit pg_hba.conf on pem server

hostssl pem      +pem_user   10.91.10.229/32 md5
 hostssl pem      +pem_agent  10.91.10.229/32 cert
 hostssl postgres +pem_user   10.91.10.229/32 md5

 hostssl pem +pem_user        10.91.10.226/32 md5
 hostssl pem +pem_agent        10.91.10.226/32 cert
 hostssl postgres +pem_user   10.91.10.226/32 md5

 hostssl pem +pem_user        10.91.10.227/32 md5
 hostssl pem +pem_agent       10.91.10.227/32 cert
 hostssl postgres +pem_user   10.91.10.227/32 md5



-- reload pem db
pg_ctl reload

-- 

cd /usr/pem/agent on mnanaged db server ( password is pem db user "postgres" password)

[root@pg-prd1 agent]# PGPASSWORD=postgres /usr/pem/agent/bin/
--register-agent --pem-server pem-prd --pem-port 5432 --pem-user postgres
Postgres Enterprise Manager Agent registered successfully!
[root@pg-prd1 agent]#



-- Edit pem-agent file on managed db server

Adding following to file: /usr/pem/agent/etc/ agent.cfg
heartbeat_connection = true
ca_file=/usr/libexec/libcurl-pem7/share/certs/ca-bundle.cr

-- start pemagent on manged db server 
systemctl start pemagent


/var/log/pem
[root@pg-prd2 pem]# cat worker.log
Fri Nov 10 10:48:24 2017 : WARNING: unable to connect to PEM database: FATAL:  no pg_hba.conf entry for host "10.91.10.227", user "agent4", database "pem", SSL on

Fri Nov 10 10:48:54 2017 : WARNING: unable to connect to PEM database: FATAL:  no pg_hba.conf entry for host "10.91.10.227", user "agent4", database "pem", SSL on

Fri Nov 10 10:49:24 2017 : WARNING: unable to connect to PEM database: FATAL:  no pg_hba.conf entry for host "10.91.10.227", user "agent4", database "pem", SSL on

Fri Nov 10 10:49:54 2017 : WARNING: unable to connect to PEM database: FATAL:  no pg_hba.conf entry for host "10.91.10.227", user "agent4", database "pem", SSL on

[root@pg-prd2 pem]# pwd


select * from pem.agent ;

update pem.agent set active=true where id=3;

efm instll location: /usr/efm-2.1/bin

-- test connection to db with vip 
-bash-4.2$ psql -h 10.91.10.226 postgres -U postgres -p 5444                    Password for user postgres:
psql.bin (9.6.3, server 9.6.5.10)
Type "help" for help.

postgres=# \q
could not save history to file "/opt/PostgreSQL/9.6/.psql_history": Permission denied
-bash-4.2$ psql -h 10.91.10.225 postgres -U postgres -p 5444
Password for user postgres:
psql.bin (9.6.3, server 9.6.5.10)
Type "help" for help.


===================

customer email: tomislav.goles@qsinvestors.com

pem server key: 
Product Key = 4008J-6GL6H-RB010-1SRYH-JBNP7

EFM key: 4008J-6GL6H-RB010-7S412-GCTFN

-- stop efm 
  /usr/efm-2.1/bin/efm stop-cluster efm

-- start efm
/usr/efm-2.1/bin/runefm.sh  start efm 

-- ADD PEMAGEN AT 10.81.10.26

PGPASSWORD=postgres /usr/pem/agent/bin/pemworker --register-agent --pem-server pem-dr --pem-port 5432 --pem-user postgres

+++++++++++++++++++++++++++++++
2017-11-13:

-- put all of config files in into /var/pg_configuration

-- change include_dir to /var/pg_configuration
# These options allow settings to be loaded from files other than the
# default postgresql.conf.

#include_dir = 'conf.d'                 # include files ending in '.conf' from
                                        # directory 'conf.d'
#include_if_exists = 'exists.conf'      # include file only if it exists
#include = 'special.conf'               # include file
============================
#2017-11-14
MOVE $PGDATA/pg_xlog to new mount poin /var/pg_xlog

pg_ctl stop $PGDATA

check pg_xlog mount point:

  /var/pg_xlog

mv $PGDATA/pg_xlog/* /var/pg_xlog/

rmdir $PGDATA/pg_xlog

ln -s /var/pg_xlog/ $PGDATA/pg_xlog

pg_ctl start $PGDATA

==============================
change log directory in postgresql.conf

log_directory = '/var/pg_log'

========================
-- change pg_prd primary_conninfo in recovery.conf IP to vip as 10.91.10.225 which is priamry IP now 
1: stop db 
2: change host=10.91.10.226 to vip host=10.91.10.225 in recovery.conf in pg-dr

primary_conninfo = 'user=repuser host=10.91.10.225 port=5444 sslmode=prefer sslcompression=1 krbsrvname=postgres target_session_attrs=any'
3: add 10.91.10.225:5444:replication:repuser:reppass to .pgpass at pg-dr /home/enterprisedb/.pgpass

[enterprisedb@pg-dr ~]$ cat .pgpass
localhost:5444:replication:repuser:reppass
10.91.10.226:5444:replication:repuser:reppass
10.91.10.227:5444:replication:repuser:reppass
10.81.10.226:5444:replication:repuser:reppass
10.91.10.225:5444:replication:repuser:reppass
4: start pg-dr 
    pg_ctl -D $PDDATA
    
  ====================================  
-- install bart :

 yum install edb-bart20

==================
-- verify streaming replication 
[enterprisedb@pg-prd2 data]$ ps -ef | grep receiver
enterpr+  4480  4473  0 Nov14 ?        00:01:51 postgres: wal receiver process   streaming 0/555D09B0
enterpr+ 19888 17946  0 10:31 pts/1    00:00:00 grep --color=auto receiver
[enterprisedb@pg-prd2 data]$
-- query to check streaming replication 

select usename,client_addr,sent_location,write_location from pg_stat_replication;
[enterprisedb@pg-prd1 ~]$ psql postgres -U postgres
psql.bin (9.6.5.10)
Type "help" for help.

postgres=# select usename,client_addr,sent_location,write_location from pg_stat_replication;
 usename | client_addr  | sent_location | write_location
---------+--------------+---------------+----------------
 repuser | 10.91.10.227 | 0/555D0B70    | 0/555D0B70
 repuser | 10.81.10.226 | 0/555D0B70    | 0/555D0B70
(2 rows)

postgres=#
=================================
-- edit postgresql.conf both primary and standby 

# Add settings for extensions here
edb_dynatune = 100
log_directory = '/var/pg_log'
max_connections = 300
shared_buffers = 10GB
effective_cache_size = 36GB
work_mem = 128MB
maintenance_work_mem = 2GB
default_statistics_target = 100
max_worker_processes = 12

hot_standby = on
hot_standby_feedback = on
max_wal_senders = 6
wal_level =  replica #hot_standby
archive_mode = on
archive_command = '/bin/rue'
wal_buffers = 64MB
wal_log_hints = on
wal_compression = off

logging_collector = on
log_lock_waits = on
log_temp_files = 0
log_checkpoints = on
log_autovacuum_min_duration = 0
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d'
log_min_duration_statement = 1000
log_autovacuum_min_duration = 0
log_checkpoints = on

min_wal_size = 1GB
max_wal_size = 10GB

bgwriter_delay = 100ms
bgwriter_lru_maxpages = 1000
bgwriter_lru_multiplier = 4
checkpoint_completion_target = 0.9
checkpoint_timeout = 5min
checkpoint_warning = 1min
cpu_tuple_cost = 0.03
random_page_cost = 2
max_parallel_workers_per_gather = 4

autovacuum = on
autovacuum_vacuum_cost_delay = 10ms
autovacuum_max_workers = 3
autovacuum_naptime = 5
autovacuum_vacuum_scale_factor = 0.05
autovacuum_analyze_scale_factor = 0.05
autovacuum_vacuum_cost_limit = -1
vacuum_cost_limit = 800

max_replication_slots = 10
full_page_writes = on

==========================
2017-11-17 13:14:11 EST [19675]: [1-1] user=,db=LOG:  started streaming WAL from primary at 0/56000000 on timeline 1
2017-11-17 13:14:11 EST [4476]: [7-1] user=,db=FATAL:  hot standby is not possible because max_worker_processes = 8 is a lower setting than on the master server (its value was 12)
2017-11-17 13:14:11 EST [4476]: [8-1] user=,db=CONTEXT:  xlog redo at 0/56000098 for XLOG/PARAMETER_CHANGE: max_connections=300 max_worker_processes=12 max_prepared_xacts=0 max_locks_per_xact=64 wal_level=replica wal_log_hints=on track_commit_timestamp=off
2017-11-17 13:14:11 EST [4473]: [13-1] user=,db=LOG:  startup process (PID 4476) exited with exit code 1
2017-11-17 13:14:11 EST [4473]: [14-1] user=,db=LOG:  terminating any other active server processes
2017-11-17 13:14:11 EST [18674]: [1-1] user=postgres,db=postgresWARNING:  terminating connection because of crash of another server process
2017-11-17 13:14:11 EST [18674]: [2-1] user=postgres,db=postgresDETAIL:  The postmaster has commanded this server process to roll back the current transaction and exit, because another server process exited abnormally and possibly corrupted shared memory.
2017-11-17 13:14:11 EST [18674]: [3-1] user=postgres,db=postgresHINT:  In a moment you should be able to reconnect to the database and repeat your command.
2017-11-17 13:14:11 EST [7836]: [1-1] user=postgres,db=postgresWARNING:  terminating connection because of crash of another server process
2017-11-17 13:14:11 EST [7836]: [2-1] user=postgres,db=postgresDETAIL:  The postmaster has commanded this server process to roll back the current transaction and exit, because another server process exited abnormally and possibly corrupted shared memory.
2017-11-17 13:14:11 EST [7836]: [3-1] user=postgres,db=postgresHINT:  In a moment you should be able to reconnect to the database and repeat your command.
2017-11-17 13:14:11 EST [4473]: [15-1] user=,db=LOG:  database system is shut down
[enterprisedb@pg-prd2 pg_log]$ cd $PGDATA
[enterprisedb@pg-prd2 data]$ vi postgresql.conf

===============================
test mail function in pem-dr 

[enterprisedb@pem-dr ~]$ mail -s "test" guorong.zhang@enterprisedb.com < test.txt
-- i got this email 
sender: enterprisedb@pem-dr.localdomain

[enterprisedb@pem-dr ~]$ echo " from qsi"| mail -s "test" guorong.zhang@enterprisedb.com
You have mail in /var/spool/mail/enterprisedb
-- i also  get this email 
sender:enterprisedb@pem-dr.localdomain
=======================================
pg-prd efm file:
[root@pg-prd1 efm-2.1]# cat efm.properties | grep -v "\#"


efm.license=4008J-6GL6H-RB010-7S412-GCTFN

db.user=postgres
db.password.encrypted=22a85432353cbff0bb8b4cab6cd53045
db.port=5444
db.database=postgres

db.service.owner=enterprisedb

db.service.name=

db.bin=/usr/edb/as9.6/bin

db.recovery.conf.dir=/var/lib/edb/as9.6/data

jdbc.ssl=false
jdbc.ssl.mode=verify-ca

user.email=guorong.zhang@enterprisedb.com

script.notification=

bind.address=10.91.10.226:7809

admin.port=7800

is.witness=false

local.period=10
local.timeout=60
local.timeout.final=10

remote.timeout=10

node.timeout=50

pingServerIp=8.8.8.8

pingServerCommand=/bin/ping -q -c3 -w5

auto.allow.hosts=true

db.reuse.connection.count=0

auto.failover=false

auto.reconfigure=true

promotable=true

minimum.standbys=0

recovery.check.period=2

auto.resume.period=0

virtualIp=10.91.10.225
virtualIp.interface=ens192:0
virtualIp.netmask=255.255.255.0

script.fence=

script.post.promotion=

script.resumed=

script.db.failure=

script.master.isolated=

sudo.command=sudo
sudo.user.command=sudo -u %u

jgroups.loglevel=INFO
efm.loglevel=INFO

jvm.options=-Xmx32m
[root@pg-prd1 efm-2.1]#

==================
pem export bug in pem:
-- when export db from pem and got :

{"success":0,"errormsg":"ERROR:  could not open relation with OID 23025\n","data":null,"info":"","result":null}

===================================
-- check why efm stopped on 11/22/2017
--efm log on pg-prd2:
11/22/17 2:57:07 PM com.enterprisedb.efm.nodes.EfmAgent doHandle INFO: responding to db status request with status:10.226%%true%%true%%

11/22/17 2:57:07 PM com.enterprisedb.efm.admin.AdminServerThread processRequest INFO: admin service responding: Mas26%%true%%true%% ||Standby%%10.91.10.227%%true%%true%% ||Witness%%10.91.10.229%%true%%false%% ||10.91.10.226 10.91..229%%10.91.10.226%%10.91.10.227

11/22/17 3:00:34 PM com.enterprisedb.efm.nodes.EfmAgent doHandle INFO: responding to db status request with status:10.226%%true%%true%%

--efm-log on pg-prd2
11/22/17 3:15:35 AM com.enterprisedb.efm.nodes.EfmNode checkClusterStatus INFO: Sending status message to all nodes: node_status

11/22/17 3:15:35 AM com.enterprisedb.efm.nodes.EfmAgent doHandle INFO: responding to db status request with status: Standby%%10.91.10.227%%true%%true%%

11/22/17 3:15:35 AM com.enterprisedb.efm.admin.AdminServerThread processRequest INFO: admin service responding: Witness%%10.91.10.229%%true%%false%% ||Standby%%10.91.10.227%%true%%true%% ||Master%%10.91.10.226%%true%%true%% ||10.91.10.226 10.91.10.227 10.91.10.229%%10.91.10.226%%10.91.10.227
--efm-log on pem-prd :
11/22/17 2:57:07 PM com.enterprisedb.efm.nodes.EfmWitness doHandle INFO: responding to db status request with status: Witness%%10.91.10.229%%true%%false%%

11/22/17 3:00:30 PM com.enterprisedb.efm.nodes.EfmWitness doHandle INFO: responding to db status request with status: Witness%%10.91.10.229%%true%%false%%

11/22/17 3:01:13 PM com.enterprisedb.efm.nodes.EfmWitness doHandle INFO: responding to db status request with status: Witness%%10.91.10.229%%true%%false%%

11/22/17 3:02:10 PM com.enterprisedb.efm.nodes.EfmNode suspect WARNING: Address suspect: pg-prd2-44343 at 10.91.10.227

11/22/17 3:02:10 PM com.enterprisedb.efm.nodes.EfmNode suspect WARNING: Address suspect: pg-prd1-4519 at 10.91.10.226

11/22/17 3:02:10 PM com.enterprisedb.efm.nodes.EfmNode viewAccepted INFO: View changed. I am pem-prd-49337 Total jgroups nodes: 1

11/22/17 3:02:10 PM com.enterprisedb.efm.nodes.EfmNode updateNodesFile INFO: New .nodes file information:

11/22/17 3:02:10 PM com.enterprisedb.efm.exec.ExecUtil performExec INFO: [sudo /usr/efm-2.1/bin/efm_root_functions writenodes efm ]

11/22/17 3:02:10 PM com.enterprisedb.efm.utils.ClusterStateVerifier$TimerThread run INFO: Cluster state verifier thread started.

11/22/17 3:02:10 PM com.enterprisedb.efm.exec.ExecUtil performExec INFO: ProcessResult{exitValue=0, errorOut='', stdOut=''}

11/22/17 3:02:10 PM com.enterprisedb.efm.nodes.EfmNode updateStableClusterSize INFO: Cluster size now 1, was 3.

11/22/17 3:02:10 PM com.enterprisedb.efm.nodes.EfmNode nodeStillUp INFO: Checking to see if node is responsive. Check type: DB_PING

11/22/17 3:02:10 PM com.enterprisedb.efm.DBMonitor checkOnce INFO: DB monitor testing jdbc:postgresql://10.91.10.227:5444/postgres?ApplicationName='efm-2.1'

11/22/17 3:02:13 PM com.enterprisedb.efm.DBMonitor checkOnce WARNING: Could not connect to database at 10.91.10.227: org.postgresql.util.PSQLException: The connection attempt failed., state: 08001, time: 2,945

11/22/17 3:02:13 PM com.enterprisedb.efm.nodes.EfmNode nodeStillUp INFO: Cleaning thread db_ping_local in case still running.

11/22/17 3:02:13 PM com.enterprisedb.efm.nodes.EfmNode nodeStillUp INFO: Cleaning thread ping_monitor in case still running.

11/22/17 3:02:13 PM com.enterprisedb.efm.nodes.EfmNode nodeStillUp INFO: Checking to see if node is responsive. Check type: DB_PING

11/22/17 3:02:13 PM com.enterprisedb.efm.DBMonitor checkOnce INFO: DB monitor testing jdbc:postgresql://10.91.10.226:5444/postgres?ApplicationName='efm-2.1'

11/22/17 3:02:16 PM com.enterprisedb.efm.DBMonitor checkOnce WARNING: Could not connect to database at 10.91.10.226: org.postgresql.util.PSQLException: The connection attempt failed., state: 08001, time: 3,007

11/22/17 3:02:16 PM com.enterprisedb.efm.nodes.EfmNode nodeStillUp INFO: Cleaning thread db_ping_local in case still running.

11/22/17 3:02:16 PM com.enterprisedb.efm.nodes.EfmNode nodeStillUp INFO: Cleaning thread ping_monitor in case still running.

11/22/17 3:02:16 PM com.enterprisedb.efm.nodes.EfmNode updateStableClusterSize INFO: At least one node was suspect before leaving. Starting timer to update known cluster size.

11/22/17 3:02:16 PM com.enterprisedb.efm.exec.ExecUtil performExec INFO: [/bin/ping -q -c3 -w5 8.8.8.8]

11/22/17 3:02:16 PM com.enterprisedb.efm.utils.ClusterSizeUpdater$TimerThread run INFO: updater thread started

11/22/17 3:02:18 PM com.enterprisedb.efm.exec.ExecUtil performExec INFO: ProcessResult{exitValue=0, errorOut='', stdOut='PING 8.8.8.8 (8.8.8.8) 56(84) bytes of data.

--- 8.8.8.8 ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 2002ms
rtt min/avg/max/mdev = 1.273/1.352/1.468/0.083 ms'}

11/22/17 3:02:18 PM com.enterprisedb.efm.utils.ClusterUtils pingHost INFO: ProcessResult{exitValue=0, errorOut='', stdOut='PING 8.8.8.8 (8.8.8.8) 56(84) bytes of data.

--- 8.8.8.8 ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 2002ms
rtt min/avg/max/mdev = 1.273/1.352/1.468/0.083 ms'}

11/22/17 3:02:18 PM com.enterprisedb.efm.ClusterState removeAddress INFO: Removing standby address pg-prd2-44343

11/22/17 3:02:18 PM com.enterprisedb.efm.ClusterState removeAddress INFO: Removing standby info 10.91.10.227 from failover priority list.

11/22/17 3:02:18 PM com.enterprisedb.efm.nodes.EfmNode handleMissingNonMasterNodes WARNING: Missing nodes: Standby:pg-prd2-44343

11/22/17 3:02:18 PM com.enterprisedb.efm.nodes.EfmNode handleViewChange SEVERE: Master node has disappeared.

11/22/17 3:02:18 PM com.enterprisedb.efm.utils.Notifications sendMail INFO: Sending notification:
To: [guorong.zhang@enterprisedb.com]
Subject: [WARNING] EFM Subset of cluster efm disconnected from master
Body:
EFM node:     10.91.10.229
Cluster name:  efm
Database name: postgres
VIP support:   ENABLED
Auto Failover: DISABLED

This node is no longer connected to the majority of the cluster
efm. Because this node is part of a subset of the cluster, failover
will not be attempted. Current nodes that are visible are:
10.91.10.229

11/22/17 3:02:18 PM com.enterprisedb.efm.nodes.EfmNode nodeStillUp INFO: Checking to see if node is responsive. Check type: DB_PING

11/22/17 3:02:18 PM com.enterprisedb.efm.DBMonitor checkOnce INFO: DB monitor testing jdbc:postgresql://10.91.10.227:5444/postgres?ApplicationName='efm-2.1'

11/22/17 3:02:21 PM com.enterprisedb.efm.DBMonitor checkOnce WARNING: Could not connect to database at 10.91.10.227: org.postgresql.util.PSQLException: The connection attempt failed., state: 08001, time: 3,005

11/22/17 3:02:21 PM com.enterprisedb.efm.nodes.EfmNode nodeStillUp INFO: Cleaning thread db_ping_local in case still running.

11/22/17 3:02:21 PM com.enterprisedb.efm.nodes.EfmNode nodeStillUp INFO: Cleaning thread ping_monitor in case still running.

11/22/17 3:02:21 PM com.enterprisedb.efm.utils.Notifications sendMail INFO: Sending notification:
To: [guorong.zhang@enterprisedb.com]
Subject: [WARNING] EFM No standby agent in cluster for cluster efm
Body:
EFM node:     10.91.10.229
Cluster name:  efm
Database name: postgres
VIP support:   ENABLED
Auto Failover: DISABLED

The standby on 10.91.10.227 has left the cluster.

11/22/17 3:03:50 PM com.enterprisedb.efm.utils.ClusterStateVerifier$TimerThread run INFO: verifier thread exiting

11/22/17 3:03:50 PM com.enterprisedb.efm.nodes.EfmWitness doHandle INFO: responding to db status request with status: Witness%%10.91.10.229%%true%%false%%

11/22/17 3:07:16 PM com.enterprisedb.efm.nodes.EfmNode updateStableSize INFO: stable cluster size now 1

[root@pem-prd efm-2.1]#

[root@pg-prd1 ~]# systemctl enable pemagent
Created symlink from /etc/systemd/system/multi-user.target.wants/pemagent.service to /usr/lib/systemd/system/pemagent.service.
[root@pg-prd1 ~]#


-- enable start service when boot 
[root@pg-prd2 ~]# systemctl enable edb-as-9.6
Created symlink from /etc/systemd/system/multi-user.target.wants/edb-as-9.6.service to /usr/lib/systemd/system/edb-as-9.6.service.
[root@pg-prd2 ~]#

-- enable service when start os
[root@pg-prd1 efm-2.1]# systemctl enable efm-2.1
Created symlink from /etc/systemd/system/multi-user.target.wants/efm-2.1.service to /usr/lib/systemd/system/efm-2.1.service.
[root@pg-prd1 efm-2.1]#
============================
pg-prd1 pemagent log 

Tue Nov 21 14:31:09 2017 : WARNING: Heartbeat: Unable to ping server: 4, error: FATAL:  terminating connection due to administrator command
server closed the connection unexpectedly
        This probably means the server terminated abnormally
        before or while processing the request.
.
Mon Nov 27 17:34:50 2017 : WARNING: failed to query jobs table: FATAL:  terminating connection due to administrator command
server closed the connection unexpectedly
        This probably means the server terminated abnormally
        before or while processing the request.
Archiving Log Enabled
===================
Directory to local = /var/wal_arch running successfully.

[enterprisedb@pg-prd1 wal_arch]$ ps -ef | grep postgres
enterpr+  2181  1928  0 Nov27 ?        00:00:00 postgres: logger process
enterpr+  2271  1928  0 Nov27 ?        00:00:08 postgres: checkpointer process
enterpr+  2272  1928  0 Nov27 ?        00:00:01 postgres: writer process
enterpr+  2273  1928  0 Nov27 ?        00:00:01 postgres: wal writer process
enterpr+  2274  1928  0 Nov27 ?        00:00:32 postgres: autovacuum launcher process
enterpr+  2275  1928  0 Nov27 ?        00:00:05 postgres: archiver process   archiving 0000000100000002000000A5

Status of Replication of both standbys(NY DC/NJ DR)
=====
[enterprisedb@pg-prd1 wal_arch]$ ps -ef | grep send
enterpr+  5479 28162  0 11:05 pts/2    00:00:00 grep --color=auto send
enterpr+  6290  1928  0 09:12 ?        00:00:00 postgres: wal sender process repuser 10.91.10.227[45498] streaming 12/91000220
enterpr+ 10514  1928  0 09:27 ?        00:00:00 postgres: wal sender process repuser 10.81.10.226[39256] streaming 12/91000220

EFM STatus Check
------------------
[root@pg-prd1 ~]# /usr/efm-2.1/bin/efm cluster-status efm
Cluster Status: efm
VIP: 10.91.10.225
Automatic failover is disabled.

        Agent Type  Address              Agent  DB       Info
        --------------------------------------------------------------
        Witness     10.91.10.229         UP     N/A
        Standby     10.91.10.227         UP     UP
        Master      10.91.10.226         UP     UP

Allowed node host list:
        10.91.10.226 10.91.10.227 10.91.10.229

Membership coordinator: 10.91.10.226

Standby priority host list:
        10.91.10.227

Promote Status:

        DB Type     Address              XLog Loc         Info
        --------------------------------------------------------------
        Master      10.91.10.226         12/91000300
        Standby     10.91.10.227         12/91000300

        Standby database(s) in sync with master. It is safe to promote.
[root@pg-prd1 ~]#
-- mv archive file to /var/pg_xlog/tmp_archive/ in pg-prd1

 find /var/wal_arch/ -mmin  +1200 -exec mv "{}" /var/pg_xlog/tmp_archive/ \;
 
 
 
 -rw-------. 1 enterprisedb enterprisedb 16777216 Nov 29 15:48 00000001000000AD00000023
-rw-------. 1 enterprisedb enterprisedb 16777216 Nov 29 15:48 00000001000000AD00000024
-rw-------. 1 enterprisedb enterprisedb 16777216 Nov 29 15:48 00000001000000AD00000025
-rw-------. 1 enterprisedb enterprisedb 16777216 Nov 29 15:48 00000001000000AD00000026
-rw-------. 1 enterprisedb enterprisedb 16777216 Nov 29 15:48 00000001000000AD00000027
-rw-------. 1 enterprisedb enterprisedb 16777216 Nov 29 15:48 00000001000000AD00000028
-rw-------. 1 enterprisedb enterprisedb 16777216 Nov 29 15:48 00000001000000AD00000029
-rw-------. 1 enterprisedb enterprisedb 16777216 Nov 29 15:48 00000001000000AD0000002A
-rw-------. 1 enterprisedb enterprisedb 16777216 Nov 29 15:48 00000001000000AD0000002B
-rw-------. 1 enterprisedb enterprisedb 16777216 Nov 29 15:48 00000001000000AD0000002C
-rw-------. 1 enterprisedb enterprisedb 16777216 Nov 29 15:48 00000001000000AD0000002D
-rw-------. 1 enterprisedb enterprisedb 16777216 Nov 29 15:48 00000001000000AD0000002E
-rw-------. 1 enterprisedb enterprisedb 16777216 Nov 29 15:48 00000001000000AD0000002F
===========================
SELECT pg_size_pretty( SUM(pg_database_size(datname))::bigint ) As Total_db_size   from pg_database

=============
-- check schema size for db data-warehouse in pg-prd1


postgres=# \c data_warehouse
You are now connected to database "data_warehouse" as user "postgres".
data_warehouse=# SELECT schema_name,
data_warehouse-#        pg_size_pretty(sum(table_size)::bigint),
data_warehouse-#        (sum(table_size) / pg_database_size(current_database())) * 100
data_warehouse-# FROM (
data_warehouse(#   SELECT pg_catalog.pg_namespace.nspname as schema_name,
data_warehouse(#          pg_relation_size(pg_catalog.pg_class.oid) as table_size
data_warehouse(#   FROM   pg_catalog.pg_class
data_warehouse(#      JOIN pg_catalog.pg_namespace ON relnamespace = pg_catalog.pg_namespace.oid
data_warehouse(# ) t
data_warehouse-# GROUP BY schema_name
data_warehouse-# ORDER BY schema_name;
    schema_name     | pg_size_pretty |            ?column?
--------------------+----------------+--------------------------------
 dbms_aq            | 0 bytes        | 0.0000000000000000000000000000
 dbms_aqadm         | 0 bytes        | 0.0000000000000000000000000000
 entity_master      | 116 GB         |        52.02720765064082365600
 information_schema | 96 kB          |     0.000041100811410031362500
 pg_catalog         | 227 MB         |         0.09957646561721659300
 pg_toast           | 423 MB         |         0.18561657594957363100
 public             | 38 GB          |        16.83843474505911457400
 sys                | 104 kB         |     0.000044525148544657085400
 temp_data          | 69 GB          |        30.80253500033396663200
(9 rows)

-- check schema size for db data-warehouse in pg-prd2
postgres=# \c data_warehouse
You are now connected to database "data_warehouse" as user "postgres".
data_warehouse=# SELECT schema_name,
data_warehouse-#        pg_size_pretty(sum(table_size)::bigint),
data_warehouse-#        (sum(table_size) / pg_database_size(current_database())) * 100
data_warehouse-# FROM (
data_warehouse(#   SELECT pg_catalog.pg_namespace.nspname as schema_name,
data_warehouse(#          pg_relation_size(pg_catalog.pg_class.oid) as table_size
data_warehouse(#   FROM   pg_catalog.pg_class
data_warehouse(#      JOIN pg_catalog.pg_namespace ON relnamespace = pg_catalog.pg_namespace.oid
data_warehouse(# ) t
data_warehouse-# GROUP BY schema_name
data_warehouse-# ORDER BY schema_name;
    schema_name     | pg_size_pretty |            ?column?
--------------------+----------------+--------------------------------
 dbms_aq            | 0 bytes        | 0.0000000000000000000000000000
 dbms_aqadm         | 0 bytes        | 0.0000000000000000000000000000
 entity_master      | 116 GB         |        69.16701213754876347100
 information_schema | 96 kB          |     0.000054556621579716893400
 pg_catalog         | 229 MB         |         0.13310451749911429100
 pg_toast           | 239 MB         |         0.13924213742683244100
 public             | 38 GB          |        22.47446386821042494800
 sys                | 104 kB         |     0.000059103006711359967900
 temp_data          | 14 GB          |         8.05621718519718614200
(9 rows)

-- check schema size for db data-warehouse in pg-dr

postgres=# \c data_warehouse
You are now connected to database "data_warehouse" as user "postgres".
data_warehouse=# SELECT schema_name,
data_warehouse-#        pg_size_pretty(sum(table_size)::bigint),
data_warehouse-#        (sum(table_size) / pg_database_size(current_database())) * 100
data_warehouse-# FROM (
data_warehouse(#   SELECT pg_catalog.pg_namespace.nspname as schema_name,
data_warehouse(#          pg_relation_size(pg_catalog.pg_class.oid) as table_size
data_warehouse(#   FROM   pg_catalog.pg_class
data_warehouse(#      JOIN pg_catalog.pg_namespace ON relnamespace = pg_catalog.pg_namespace.oid
data_warehouse(# ) t
data_warehouse-# GROUP BY schema_name
data_warehouse-# ORDER BY schema_name;
    schema_name     | pg_size_pretty |            ?column?
--------------------+----------------+--------------------------------
 dbms_aq            | 0 bytes        | 0.0000000000000000000000000000
 dbms_aqadm         | 0 bytes        | 0.0000000000000000000000000000
 entity_master      | 116 GB         |        69.13502279773520907900
 information_schema | 96 kB          |     0.000054479569220874024300
 pg_catalog         | 231 MB         |         0.13429667809355620900
 pg_toast           | 242 MB         |         0.14067532765650021000
 public             | 38 GB          |        22.52531336855484715600
 sys                | 104 kB         |     0.000059019533322613526400
 temp_data          | 14 GB          |         8.03480576743806199000
(9 rows)

data_warehouse=#

==========================
setup bart 

 ssh-keygen -t rsa 
$ cat ~/.ssh/id_rsa.pub >> ~/.ssh/authorized_keys
$ chmod 600  ~/.ssh/authorized_keys


----------------
$ ssh-keygen -t rsa    # on both bart server and remote server 
$ scp ~/.ssh/id_rsa.pub enterprisedb@pg-prd2:temp.pub # from bart server
$ scp ~/.ssh/id_rsa.pub enterprisedb@pg-prd1:temp.pub # from remote server
$ cat temp.pub >> ~/.ssh/authorized_keys # on both bart server and remote  
$ chmod 600 ~/.ssh/id_rsa.pub # both bart server and remote server 

bart.cfg:

[BART]
bart_host= enterprisedb@127.0.0.1
backup_path = /backup
pg_basebackup_path = /usr/edb/as9.6/bin/bin/pg_basebackup
logfile = /tmp/bart.log
scanner_logfile = /tmp/bart_scanner.log


[PGPRDAS96]
host = 127.0.0.1
port = 5444
user = postgres
cluster_owner = enterprisedb
backup_name = dxpgedb01_%year-%month-%dayT%hour:%minute:%second
retention_policy = 2 BACKUPS
#archive_command = 'cp %p %a/%f'
allow_incremental_backups = enabled
description = "PG_PRD1 EPAS 96 server"

[enterprisedb@pg-prd1 ~]$ bart INIT -s pgprdas96
INFO:  setting archive_command for server 'pgprdas96'
WARNING: archive_command is not set for server 'pgprdas96'

[enterprisedb@pg-prd1 ~]$ bart INIT -s pgprdas96
INFO:  setting archive_command for server 'pgprdas96'
WARNING: archive_command is not set for server 'pgprdas96'
[enterprisedb@pg-prd1 ~]$ bart show-servers
SERVER NAME         : pgprdas96
BACKUP FRIENDLY NAME: pg-prd1_%year-%month-%dayT%hour:%minute:%second
HOST NAME           : 127.0.0.1
USER NAME           : postgres
PORT                : 5444
REMOTE HOST         :
RETENTION POLICY    : 2 Backups
DISK UTILIZATION    : 0.00 bytes
NUMBER OF ARCHIVES  : 0
ARCHIVE PATH        : /backup/pgprdas96/archived_wals
ARCHIVE COMMAND     : /bin/true
XLOG METHOD         : fetch
WAL COMPRESSION     : disabled
TABLESPACE PATH(s)  :
INCREMENTAL BACKUP  : ENABLED
DESCRIPTION         : "PG_PRD1 EPAS 96 server"

[enterprisedb@pg-prd1 ~]$


archive_command = 'cp %p /backup/pgprdas96/archived_wals/%f'

recovery.conf

standby_mode = on
primary_conninfo = 'Q'
trigger_file = '/tmp/postgres_promotion.trigger'
restore_command = 'cp /backup/pgprdas96/archived_wals/%f %p'
-- backup (full)

$bart backup -s pgprdas96 --backup-name pg-prd1_full_parent


-- create bart db user in pg-prd1 

CREATE ROLE bartuser WITH LOGIN SUPERUSER PASSWORD 'bartuser';
-- change db user to bartuser in bart.cfg 
-- INIT bart agqin 
 bart INIY -r -s pgprdas96
 
[enterprisedb@pg-prd1 bktest]$ bar INIT -r -s pgprdas96
bash: bar: command not found...
[enterprisedb@pg-prd1 bktest]$ bart  INIT -r -s pgprdas96
[enterprisedb@pg-prd1 bktest]$ bart show-servers
SERVER NAME         : pgprdas96
BACKUP FRIENDLY NAME: pg-prd1_%year-%month-%dayT%hour:%minute:%second
HOST NAME           : 10.91.10.226
USER NAME           : bartuser
PORT                : 5444
REMOTE HOST         :
RETENTION POLICY    : 2 Backups
DISK UTILIZATION    : 17.72 GB
NUMBER OF ARCHIVES  : 0
ARCHIVE PATH        : /backup/pgprdas96/archived_wals
ARCHIVE COMMAND     : cp %p /backup/pgprdas96/archived_wals/%f
XLOG METHOD         : fetch
WAL COMPRESSION     : disabled
TABLESPACE PATH(s)  :
INCREMENTAL BACKUP  : ENABLED
DESCRIPTION         : "PG_PRD1 EPAS 96 server"

-- try bart backup again 
[enterprisedb@pg-prd1 bktest]$ bart backup -s pgprdas96 --backup-name pg-prd1_full_parent
INFO:  creating backup for server 'pgprdas96'
INFO:  backup identifier: '1512081823004'

-- check backup 
[enterprisedb@pg-prd1 1512081823004]$ du -sh
3.4G    .
[enterprisedb@pg-prd1 1512081823004]$ pwd
/backup/pgprdas96/1512081823004
[enterprisedb@pg-prd1 1512081823004]$ du -sh
17G

--bart backu is ok 

-- re set recovery.conf in pg-dr ( passwordless is set among pg-prd1;pg-prd2 and pg-dr )

[enterprisedb@pg-dr data]$ cat recovery.conf
standby_mode = 'on'
primary_conninfo = 'user=repuser host=10.91.10.225 port=5444 sslmode=prefer sslcompression=1 krbsrvname=postgres target_session_attrs=any'
restore_command = 'scp enterprisedb@pg-prd:/backup/pgprdas96/archived_wals/%f %p'
#restore_command = 'scp pg-prd1:/backup/pgprdas96/archived_wals/%f %p'
#recovery_target_timeline = 'latest'

====================================
set up email group in pem server

sender:enterprisedb@pem-prd.localdomain
receiver: technology@qsinvestors.com 
===============================
[enterprisedb@pg-dr pg_log]$ hostname
pg-dr
[enterprisedb@pg-dr pg_log]$ host pg-dr
pg-dr.qsi.local has address 10.81.10.226
[enterprisedb@pg-dr pg_log]$
=============
enterprisedb@pem-prd ~]$ hosname
bash: hosname: command not found...
[enterprisedb@pem-prd ~]$ hostname
pem-prd
[enterprisedb@pem-prd ~]$ host pem-prd
pem-prd.qsi.local has address 10.91.10.229
[enterprisedb@pem-prd ~]$
==================
[enterprisedb@pg-prd1 archived_wals]$ hostname
pg-prd1
[enterprisedb@pg-prd1 archived_wals]$ host pg-prd1
pg-prd1.qsi.local has address 10.91.10.226
[enterprisedb@pg-prd1 archived_wals]$
==========================
[enterprisedb@pg-prd2 pg_log]$ hostname
pg-prd2
[enterprisedb@pg-prd2 pg_log]$ host pg-prd2
pg-prd2.qsi.local has address 10.91.10.227
[enterprisedb@pg-prd2 pg_log]$
================
[enterprisedb@pem-dr ~]$ hostname
pem-dr
[enterprisedb@pem-dr ~]$ host pem-dr
pem-dr.qsi.local has address 10.81.10.229
[enterprisedb@pem-dr ~]$

WAL lag:

[enterprisedb@pg-prd1 archived_wals]$ ls -l 000000010000048000000038
-rw-------. 1 enterprisedb enterprisedb 16777216 Dec  1 07:37 000000010000048000000038 -- this pg-prd2
[enterprisedb@pg-prd1 archived_wals]$ ls -l 00000001000003750000009A
-rw-------. 1 enterprisedb enterprisedb 16777216 Nov 30 21:33 00000001000003750000009A  -- this pg-dr


-- why wal size is much larger then database size???
reason; wal_max_size is too small ( current) 
postgres=# show max_wal_size;
 max_wal_size
--------------
 10GB
(1 row)

-- increase to 100GB
postgres=# alter system set max_wal_size='100GB';

postgres=# show max_wal_size;
 max_wal_size
--------------
 100GB
(1 row)


===============================================
2017-11-30 17:28:25 EST [8646]: [36-1] user=postgres,db=aristos_metadataSTATEMENT:  INSERT INTO public.data_object (resource_key, namespace, name, data_effective_dt, is_ingested, attributes, is_active, created_dt, created_by, modified_dt, modified_by) VALUES (303, 'northern trust/nt port acct/OUTBOUND_V1_QSI.Fund_', 'V1_QSI.Fund_20110620.txt', '2011-06-20T00:00:00'::timestamp, false, '{"query": {"fetch_spec": {"namespace_equals": "OUTBOUND", "name_matches_regular_expression": "(?i)^(V1_QSI\\.Fund_\\d{8,}\\.TXT)", "case_sensitive": true}, "column_names": [], "source_resource_channel_meta_name": "nt port acct test channel", "source_resource_namespace": "OUTBOUND", "source_resource_name": "V1_QSI.Fund_20110620.txt"}, "resources": {"data_object": {"channel_meta_name": "ingestion raw filesystem", "namespace": "northern trust/nt port acct/OUTBOUND_V1_QSI.Fund_", "name": "V1_QSI.Fund_20110620.txt", "source_resource_channel_meta_name": "nt port acct test channel", "source_resource_namespace": "OUTBOUND", "source_resource_name": "V1_QSI.Fund_20110620.txt", "column_names": [], "fetch_spec": {"namespace_equals": "OUTBOUND", "name_matches_regular_expression": "(?i)^(V1_QSI\\.Fund_\\d{8,}\\.TXT)", "case_sensitive": true}, "data_effective_dt": "2011-06-20T00:00:00", "has_data_effective_dt": true, "include_data_effective_dt_in_namespace": false, "include_process_execution_dt_in_namespace": false, "is_data_object": true, "is_data": true, "is_compressed": false, "is_encrypted": false, "is_excluded": false, "is_cash_projection": false, "is_performance": false, "is_returns": false, "is_fund": true, "is_security": false, "is_position": false, "is_preprocessed": false}}, "resource_subsets": {}}', true, now(), 'Aristos', now(), 'Aristos') RETURNING public.data_object.key
2017-11-30 17:32:06 EST [9972]: [1-1] user=,db=LOG:  automatic analyze of table "aristos_metadata.public.resource_processing_result" system usage: CPU 0.00s/0.01u sec elapsed 0.02 sec
2017-11-30 17:32:07 EST [3063]: [85-1] user=,db=LOG:  checkpoint starting: time
2017-11-30 17:32:12 EST [9704]: [1-1] user=postgres,db=data_warehouseLOG:  duration: 1797.970 ms  statement: UPDATE temp_data.t_1512081130_912997580 SET data_status=CASE WHEN (temp_data.t_1512081130_912997580.data_hash = entity_master.perspective_entity.data_hash) THEN 'M' ELSE 'D' END, key=entity_master.perspective_entity.key FROM entity_master.perspective_entity WHERE (temp_data.t_1512081130_912997580.identifier_value = entity_master.perspective_entity.:

===================================

-- use script to check wal lag time :

[enterprisedb@pg-prd1 ~]$ cat check_wal_lag.sh
#!/bin/bash
pgdrlastlog=$(ssh pg-dr "ls -ltr /var/pg_log| tail -1")
pgdrlastloglastline=$(echo $pgdrlastlog| awk '{print $NF}')
pgdrlastwal=$(ssh pg-dr " cat  /var/pg_log/$pgdrlastloglastline| grep restored|tail -1")
pgdrlastwalfile=$(echo $pgdrlastwal |awk '{print $10}' | sed 's/"//g')

echo " pg-dr WAL lag time:"
ls -l /backup/pgprdas96/archived_wals/$pgdrlastwalfile

pgprdlastlog=$(ssh pg-prd2 "ls -ltr /var/pg_log| tail -1")
pgprdlastloglastline=$(echo $pgprdlastlog| awk '{print $NF}')
pgprdlastwal=$(ssh pg-prd2 " cat  /var/pg_log/$pgprdlastloglastline| grep restored|tail -1")
pgprdlastwalfile=$(echo $pgprdlastwal |awk '{print $10}' | sed 's/"//g')

echo " pg-prd1 WAL lag time:"
ls -l /backup/pgprdas96/archived_wals/$pgprdlastwalfile

-- run script 
 [enterprisedb@pg-prd1 ~]$   check_wal_lag.sh > check_wal_lag.txt
[enterprisedb@pg-prd1 ~]$ cat check_wal_lag.txt
 pg-dr WAL lag time:
-rw-------. 1 enterprisedb enterprisedb 16777216 Dec  1 04:58 /backup/pgprdas96/archived_wals/000000010000044400000000
 pg-prd1 WAL lag time:
-rw-------. 1 enterprisedb enterprisedb 16777216 Dec  1 08:58 /backup/pgprdas96/archived_wals/00000001000004A1000000AB

#############################################################
Welcome to QSI
All Connections are monitored and recorded
Disconnect IMMEDIATELY if you are not  an authorized user!
#############################################################
#############################################################
Welcome to QSI
All Connections are monitored and recorded
Disconnect IMMEDIATELY if you are not  an authorized user!
#############################################################
 pg-dr on DR WAL lag time:
-rw-------. 1 enterprisedb enterprisedb 16777216 Dec  1 05:27 /backup/pgprdas96/archived_wals/000000010000044E000000A6
#############################################################
#                     Welcome to QSI                        #
#       All connections are monitored and recored           #
# Disconnect IMMEDIATELY if you are not an authorized user! #
#############################################################
#############################################################
#                     Welcome to QSI                        #
#       All connections are monitored and recored           #
# Disconnect IMMEDIATELY if you are not an authorized user! #
#############################################################
 pg-prd2 WAL lag time:
-rw-------. 1 enterprisedb enterprisedb 16777216 Dec  1 09:23 /backup/pgprdas96/archived_wals/00000001000004AB0000005F
[enterprisedb@pg-prd1 ~]$ ./check_wal_lag.sh
#############################################################
Welcome to QSI
All Connections are monitored and recorded
Disconnect IMMEDIATELY if you are not  an authorized user!
#############################################################
#############################################################
Welcome to QSI
All Connections are monitored and recorded
Disconnect IMMEDIATELY if you are not  an authorized user!
#############################################################
 pg-dr on DR WAL lag time:
-rw-------. 1 enterprisedb enterprisedb 16777216 Dec  1 05:31 /backup/pgprdas96/archived_wals/000000010000044F000000EB
#############################################################
#                     Welcome to QSI                        #
#       All connections are monitored and recored           #
# Disconnect IMMEDIATELY if you are not an authorized user! #
#############################################################
#############################################################
#                     Welcome to QSI                        #
#       All connections are monitored and recored           #
# Disconnect IMMEDIATELY if you are not an authorized user! #
#############################################################
 pg-prd2 WAL lag time:
-rw-------. 1 enterprisedb enterprisedb 16777216 Dec  1 09:25 /backup/pgprdas96/archived_wals/00000001000004AC0000005C
[enterprisedb@pg-prd1 ~]$ ./check_wal_lag.sh
#############################################################
Welcome to QSI
All Connections are monitored and recorded
Disconnect IMMEDIATELY if you are not  an authorized user!
#############################################################
#############################################################
Welcome to QSI
All Connections are monitored and recorded
Disconnect IMMEDIATELY if you are not  an authorized user!
#############################################################
 pg-dr on DR WAL lag time:
-rw-------. 1 enterprisedb enterprisedb 16777216 Dec  1 05:53 /backup/pgprdas96/archived_wals/000000010000045800000014
#############################################################
#                     Welcome to QSI                        #
#       All connections are monitored and recored           #
# Disconnect IMMEDIATELY if you are not an authorized user! #
#############################################################
#############################################################
#                     Welcome to QSI                        #
#       All connections are monitored and recored           #
# Disconnect IMMEDIATELY if you are not an authorized user! #
#############################################################
 pg-prd2 WAL lag time:
-rw-------. 1 enterprisedb enterprisedb 16777216 Dec  1 09:43 /backup/pgprdas96/archived_wals/00000001000004B20000005B
[enterprisedb@pg-prd1 ~]$ date
Fri Dec  1 12:23:02 EST 2017
[enterprisedb@pg-prd1 ~]$ date
Fri Dec  1 12:23:06 EST 2017
[enterprisedb@pg-prd1 ~]$ ./check_wal_lag.sh
#############################################################
Welcome to QSI
All Connections are monitored and recorded
Disconnect IMMEDIATELY if you are not  an authorized user!
#############################################################
#############################################################
Welcome to QSI
All Connections are monitored and recorded
Disconnect IMMEDIATELY if you are not  an authorized user!
#############################################################
 pg-dr on DR WAL lag time:
-rw-------. 1 enterprisedb enterprisedb 16777216 Dec  1 05:54 /backup/pgprdas96/archived_wals/00000001000004580000005A
#############################################################
#                     Welcome to QSI                        #
#       All connections are monitored and recored           #
# Disconnect IMMEDIATELY if you are not an authorized user! #
#############################################################
#############################################################
#                     Welcome to QSI                        #
#       All connections are monitored and recored           #
# Disconnect IMMEDIATELY if you are not an authorized user! #
#############################################################
 pg-prd2 WAL lag time:
-rw-------. 1 enterprisedb enterprisedb 16777216 Dec  1 09:43 /backup/pgprdas96/archived_wals/00000001000004B20000009E
[enterprisedb@pg-prd1 ~]$ ./check_wal_lag.sh
#############################################################
Welcome to QSI
All Connections are monitored and recorded
Disconnect IMMEDIATELY if you are not  an authorized user!
#############################################################
#############################################################
Welcome to QSI
All Connections are monitored and recorded
Disconnect IMMEDIATELY if you are not  an authorized user!
#############################################################
 pg-dr on DR WAL lag time:
-rw-------. 1 enterprisedb enterprisedb 16777216 Dec  1 06:04 /backup/pgprdas96/archived_wals/000000010000045C00000072
#############################################################
#                     Welcome to QSI                        #
#       All connections are monitored and recored           #
# Disconnect IMMEDIATELY if you are not an authorized user! #
#############################################################
#############################################################
#                     Welcome to QSI                        #
#       All connections are monitored and recored           #
# Disconnect IMMEDIATELY if you are not an authorized user! #
#############################################################
 pg-prd2 WAL lag time:
-rw-------. 1 enterprisedb enterprisedb 16777216 Dec  1 09:55 /backup/pgprdas96/archived_wals/00000001000004B5000000C2
[enterprisedb@pg-prd1 ~]$ date
Fri Dec  1 12:36:52 EST 2017
[enterprisedb@pg-prd1 ~]$ date
Fri Dec  1 12:53:58 EST 2017
[enterprisedb@pg-prd1 ~]$ ./check_wal_lag.sh
#############################################################
Welcome to QSI
All Connections are monitored and recorded
Disconnect IMMEDIATELY if you are not  an authorized user!
#############################################################
#############################################################
Welcome to QSI
All Connections are monitored and recorded
Disconnect IMMEDIATELY if you are not  an authorized user!
#############################################################
 pg-dr on DR WAL lag time:
-rw-------. 1 enterprisedb enterprisedb 16777216 Dec  1 06:20 /backup/pgprdas96/archived_wals/0000000100000461000000B7
#############################################################
#                     Welcome to QSI                        #
#       All connections are monitored and recored           #
# Disconnect IMMEDIATELY if you are not an authorized user! #
#############################################################
#############################################################
#                     Welcome to QSI                        #
#       All connections are monitored and recored           #
# Disconnect IMMEDIATELY if you are not an authorized user! #
#############################################################
 pg-prd2 WAL lag time:
-rw-------. 1 enterprisedb enterprisedb 16777216 Dec  1 10:08 /backup/pgprdas96/archived_wals/00000001000004B9000000B2
[enterprisedb@pg-prd1 ~]$ date
Fri Dec  1 12:54:08 EST 2017
[enterprisedb@pg-prd1 ~]$ date
Fri Dec  1 13:09:47 EST 2017
[enterprisedb@pg-prd1 ~]$ ./check_wal_lag.sh
#############################################################
Welcome to QSI
All Connections are monitored and recorded
Disconnect IMMEDIATELY if you are not  an authorized user!
#############################################################
#############################################################
Welcome to QSI
All Connections are monitored and recorded
Disconnect IMMEDIATELY if you are not  an authorized user!
#############################################################
 pg-dr on DR WAL lag time:
-rw-------. 1 enterprisedb enterprisedb 16777216 Dec  1 06:33 /backup/pgprdas96/archived_wals/0000000100000466000000A9
#############################################################
#                     Welcome to QSI                        #
#       All connections are monitored and recored           #
# Disconnect IMMEDIATELY if you are not an authorized user! #
#############################################################
#############################################################
#                     Welcome to QSI                        #
#       All connections are monitored and recored           #
# Disconnect IMMEDIATELY if you are not an authorized user! #
#############################################################
 pg-prd2 WAL lag time:
-rw-------. 1 enterprisedb enterprisedb 16777216 Dec  1 10:19 /backup/pgprdas96/archived_wals/00000001000004BD000000B9
[enterprisedb@pg-prd1 ~]$ date
Fri Dec  1 13:09:58 EST 2017
[enterprisedb@pg-prd1 ~]$


====================

-- remove old wal log 
enterprisedb@pg-prd1 archived_wals]$ find /backup/pgprdas96/archived_wals/ -type f -mmin +900 -exec rm {} \;

===================
modify scrip check_wal_lag.sh on pg-prd1:

[enterprisedb@pg-prd1 ~]$ cat check_wal_lag.sh
#!/bin/bash
pgdrlastlog=$(ssh pg-dr "ls -ltr /var/pg_log| tail -1")
pgdrlastloglastline=$(echo $pgdrlastlog| awk '{print $NF}')
pgdrlastwal=$(ssh pg-dr " cat  /var/pg_log/$pgdrlastloglastline| grep restored|tail -1")
pgdrlastwalfile=$(echo $pgdrlastwal |awk '{print $10}' | sed 's/"//g')

echo " pg-dr on DR WAL lag time:"
ls -l /backup/pgprdas96/archived_wals/$pgdrlastwalfile

pgprdlastlog=$(ssh pg-prd2 "ls -ltr /var/pg_log| tail -1")
pgprdlastloglastline=$(echo $pgprdlastlog| awk '{print $NF}')
pgprdlastwal=$(ssh pg-prd2 " cat  /var/pg_log/$pgprdlastloglastline| grep restored|tail -1")
pgprdlastwalfile=$(echo $pgprdlastwal |awk '{print $10}' | sed 's/"//g')

echo " pg-prd2 WAL lag time:"
ls -l /backup/pgprdas96/archived_wals/$pgprdlastwalfile

echo "current  oldest wal log time:"

cd /backup/pgprdas96/archived_wals

ls -ltr | head -n 2| grep -v total

echo " total wal files size before removing:"

du -sh

echo "remove wal file older than 600 minutes..."

find /backup/pgprdas96/archived_wals/ -type f -mmin +600 -exec rm {} \;
echo "oldest wal log file time after remove wal file older than 600 minutes:"
ls -ltr | head -n 2| grep -v total

echo " total wal file size after wal file removed:"

du -sh

cd
=============================

-- run every two hours for check_wal_log.sh 
0 */2 * * * /home/enterprisedb/check_wal_lag.sh  > /tmp/check_wal_lag.txt 2>1

===============================
2017-12-03
-- check cput usage on pg-prd1
top - 10:36:08 up 2 days, 20:33,  4 users,  load average: 8.57, 7.93, 6.30
Tasks: 599 total,   7 running, 571 sleeping,  21 stopped,   0 zombie
%Cpu(s):  2.8 us,  1.2 sy,  0.0 ni, 85.1 id, 10.6 wa,  0.0 hi,  0.2 si,  0.0 st
KiB Mem : 26397454+total,   732360 free,  8458152 used, 25478403+buff/cache
KiB Swap:  4063228 total,  2572680 free,  1490548 used. 24194822+avail Mem

  PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND
13494 enterpr+  20   0 10.597g 2.468g 2.440g R  38.5  1.0   0:30.77 edb-postmaster
26909 enterpr+  20   0 10.571g 8.629g 8.627g R  21.9  3.4   1:27.96 edb-postmaster
 6028 enterpr+  20   0 10.587g 9.405g 9.386g R  21.6  3.7   3:42.95 edb-postmaster
11769 enterpr+  20   0 10.576g 2.251g 2.245g S  11.3  0.9   0:11.49 edb-postmaster
26128 root       0 -20       0      0      0 R   5.0  0.0   1:35.78 kworker/15:0H
 3065 enterpr+  20   0 10.569g 0.010t 0.010t S   3.0  4.1  70:37.06 edb-postmaster
11701 enterpr+  20   0 10.574g 3.072g 3.067g D   3.0  1.2   0:14.25 edb-postmaster
15624 root      20   0       0      0      0 R   3.0  0.0   3:47.34 kworker/15:0

free -h
[enterprisedb@pg-prd1 archived_wals]$ free -h
              total        used        free      shared  buff/cache   available
Mem:           251G        8.0G        723M         11G        242G        230G
Swap:          3.9G        1.4G        2.5G
[enterprisedb@pg-prd1 archived_wals]$

pg-dr wal lag is removed 
--check pg-dr log:

2017-12-03 02:02:14 EST [30882]: [2-1] user=,db=FATAL:  could not receive data from WAL stream: ERROR:  requested WAL segment 00000001000006F80000005D has already been removed
..........
scp: /backup/pgprdas96/archived_wals/00000001000006F80000005E: No such file or directory
2017-12-03 10:28:45 EST [12406]: [1-1] user=,db=LOG:  started streaming WAL from primary at 6F8/5D000000 on timeline 1
2017-12-03 10:28:45 EST [12406]: [2-1] user=,db=FATAL:  could not receive data from WAL stream: ERROR:  requested WAL segment 00000001000006F80000005D has already been removed

2017-12-03 10:28:50 EST [19041]: [5-1] user=,db=LOG:  received fast shutdown request
2017-12-03 10:28:50 EST [19041]: [6-1] user=,db=LOG:  aborting any active transactions
2017-12-03 10:28:50 EST [19048]: [1593-1] user=,db=LOG:  shutting down
2017-12-03 10:28:50 EST [19048]: [1594-1] user=,db=LOG:  database system is shut down
2017-12-03 10:28:51 EST [19041]: [7-1] user=,db=LOG:  database system is shut down
[enterprisedb@pg-dr pg_log]$
--reset up pg-dr 
--save pg-dr reconvery.conf 
[enterprisedb@pg-dr data]$ cat recovery.conf
standby_mode = 'on'
primary_conninfo = 'user=repuser host=10.91.10.225 port=5444 sslmode=prefer sslcompression=1 krbsrvname=postgres target_session_attrs=any'
restore_command = 'scp enterprisedb@pg-prd:/backup/pgprdas96/archived_wals/%f %p'
#restore_command = 'scp pg-prd1:/backup/pgprdas96/archived_wals/%f %p'
#recovery_target_timeline = 'latest'
===============================
-- transfer data from pg-prd1 to pg-dr

pg-dr: /usr/edb/as9.6/bin/pg_basebackup --host=10.91.10.226 --user=repuser --pgdata=$PGDATA  --write-recovery-conf --xlog-method=stream  --progress --verbose

pg_basebackup: initiating base backup, waiting for checkpoint to complete

-- in order to speed up data loading on pg-prd1, disable archive wal log in pg-prd by set :
   archive_command = '/bin/true'
   
   -- reload db on pg-prd1 ( pg_ctl -D $PGDATA reload )
   
   -- ALSO STOP DATA TRNASFER IN PG-DR USING PG_BASEBACKUP AND REMOVE ALL OF DATA IN $PGDATA DIRECTORY.
   -- REBUILD PG-DR AFTER DATA LOADING!
   
   how to improve data loading
   

    Disable any triggers on the table

    Drop indexes before starting the import, re-create them afterwards. (It takes much less time to build an index in one pass than it does to add the same data to it progressively, and the resulting index is much more compact).

    If doing the import within a single transaction, it's safe to drop foreign key constraints, do the import, and re-create the constraints before committing. Do not do this if the import is split across multiple transactions as you might introduce invalid data.

    If possible, use COPY instead of INSERTs

    If you can't use COPY consider using multi-valued INSERTs if practical. You seem to be doing this already. Don't try to list too many values in a single VALUES though; those values have to fit in memory a couple of times over, so keep it to a few hundred per statement.

    Batch your inserts into explicit transactions, doing hundreds of thousands or millions of inserts per transaction. There's no practical limit AFAIK, but batching will let you recover from an error by marking the start of each batch in your input data. Again, you seem to be doing this already.

    Use synchronous_commit=off and a huge commit_delay to reduce fsync() costs. This won't help much if you've batched your work into big transactions, though.

    INSERT or COPY in parallel from several connections. How many depends on your hardware's disk subsystem; as a rule of thumb, you want one connection per physical hard drive if using direct attached storage.

    Set a high checkpoint_segments value and enable log_checkpoints. Look at the PostgreSQL logs and make sure it's not complaining about checkpoints occurring too frequently.

    If and only if you don't mind losing your entire PostgreSQL cluster (your database and any others on the same cluster) to catastrophic corruption if the system crashes during the import, you can stop Pg, set fsync=off, start Pg, do your import, then (vitally) stop Pg and set fsync=on again. See WAL configuration. Do not do this if there is already any data you care about in any database on your PostgreSQL install. If you set fsync=off you can also set full_page_writes=off; again, just remember to turn it back on after your import to prevent database corruption and data loss. See non-durable settings in the Pg manual.
===
2017-12-04
=================
pg-prd2 needed wal log is removed and pg-prd2 is out of sync and cannot be used as standby --- need to rebuild after data loading .

-- this is pg-prd2 log:
cp: cannot stat ‘/backup/pgprdas96/archived_wals/00000002.history’: No such file or directory
cp: cannot stat ‘/backup/pgprdas96/archived_wals/0000000100000A720000002D’: No such file or directory
2017-12-04 11:14:27 EST [14794]: [1-1] user=,db=LOG:  started streaming WAL from primary at A72/2C000000 on timeline 1
2017-12-04 11:14:27 EST [14794]: [2-1] user=,db=FATAL:  could not receive data from WAL stream: ERROR:  requested WAL segment 0000000100000A720000002C has already been removed

-- stop pg-prd2 :
  pg_ctl -D $PGDATA stop
  
 --- stop efm on pg-prd1 ( becuase standby is shutdonw in purpose).
 [root@pg-prd1 ~]# /usr/efm-2.1/bin/efm stop-cluster efm

-- pgsql_tmp is over 2TB data ????
[enterprisedb@pg-prd1 base]$ pwd
/var/data/base
[enterprisedb@pg-prd1 base]$ du -sh *
8.7M    1
8.6M    13712
8.7M    13713
185M    16391
753G    16392
173G    16393
8.7M    16394
2.1T    pgsql_tmp
[enterprisedb@pg-prd1 base]$
-- check temp file:

SELECT temp_files AS "Temporary files"
     , temp_bytes AS "Size of temporary files"
FROM   pg_stat_database db;

 Temporary files | Size of temporary files
-----------------+-------------------------
               0 |                       0
               0 |                       0
               0 |                       0
            9444 |           5473844360435
              29 |             29834813440
               0 |                       0
               0 |                       0
(7 rows)

postgres=# SELECT temp_files AS "Temporary files"
     , temp_bytes AS "Size of temporary files"
FROM   pg_stat_database db;
 Temporary files | Size of temporary files
-----------------+-------------------------
               0 |                       0
               0 |                       0
               0 |                       0
            9444 |           5473844360435
              29 |             29834813440
               0 |                       0
               0 |                       0
(7 rows)
:/var/data/base/pgsql_tmp  --> over 3TB 
select t1.datname AS db_name,  
       pg_size_pretty(pg_database_size(t1.datname)) as db_size
from pg_database t1
order by pg_database_size(t1.datname) desc;

postgres=# select t1.datname AS db_name,
postgres-#        pg_size_pretty(pg_database_size(t1.datname)) as db_size
postgres-# from pg_database t1
postgres-# order by pg_database_size(t1.datname) desc;

     db_name      | db_size
------------------+---------
 data_warehouse   | 752 GB
 qsi              | 172 GB
 aristos_metadata | 185 MB
 sandbox          | 8855 kB
 postgres         | 8831 kB
 template1        | 8831 kB
 template0        | 8689 kB
(7 rows)

-- increase work_mem can avoid huge temp file 

can change work_mem at session level ad belwo or globlly by reset it in postgresql.conf and reload 

[enterprisedb@pg-prd1 base]$ psql postgres postgres
psql.bin (9.6.5.10)
Type "help" for help.

postgres=# show work_mem;
 work_mem
----------
 128MB
(1 row)

postgres=# \q
[enterprisedb@pg-prd1 base]$ psql postgres postgres
psql.bin (9.6.5.10)
Type "help" for help.

postgres=# show work_mem;
 work_mem
----------
 128MB
(1 row)

postgres=# alter session set work_mem='1GB';
ALTER SESSION
postgres=# show work_mem;
 work_mem
----------
 1GB
(1 row)

postgres=# alter session set work_mem='126MB';
ALTER SESSION
postgres=# show work_mem;
 work_mem
----------
 126MB
(1 row)

postgres=# alter system  set work_mem='1GB';
ALTER SYSTEM
postgres=# show work_mem;
 work_mem
----------
 126MB
(1 row)

postgres=#

================
-- adam responded QSI as:
The work_mem parameter which controls the amount of memory for sorts and hashes can be increased globally to reduce the amount of temp files be generated, but setting this parameter too high is risky because the memory on the server can be exhausted with multiple concurrent queries (the memory is per planner node ). Alternatively, work_mem can be set differently for an individual user or even for a single session. The value work_mem is currently set at '128MB' on pg-prd1. You can set work_mem for the data loading process by running 'set work_mem to '512MB' during the session and you can verify the effective value by running 'show work_mem'. 

Also, be sure that statistics are up to date with ANALYZE on the tables be queried so that planner is correctly deciding to a hash-join. That is the approach we recommend: 1) verify the statistics are up to date by running ANALYZE on the tables accessed during this process and then 2) set 'work_mem' higher for this session and verify how that affects this process. The only option after that is to get the EXPLAIN plans and look closely at the SQL being called. 

===============================

-- this script for checking db info on pg-prd1
[enterprisedb@pg-prd1 ~]$ cat  check_pg-prd1.sh
#!/bin/bash
rm /tmp/check_pg-prd1.txt
touch /tmp/check_pg-prd1.txt

printf  "\nCurrent time:\n" >> /tmp/check_pg-prd1.txt
date >>  /tmp/check_pg-prd1.txt
printf  "\nCurrent size at /var/data:\n" >> /tmp/check_pg-prd1.txt

df -h | grep "/var/data"  >> /tmp/check_pg-prd1.txt

printf  "\nCurrent db size:\n" >> /tmp/check_pg-prd1.txt

psql postgres postgres -c 'select t1.datname AS db_name,  pg_size_pretty(pg_database_size(t1.datname)) as db_size from pg_database t1 order by pg_database_size(t1.datname) desc;' >> /tmp/check_pg-prd1.txt

printf " \nCheck db runing:\n" >> /tmp/check_pg-prd1.txt

ps -ef | grep 'postmaster' >> /tmp/check_pg-prd1.txt

mailx  -s "Current DB status in pg-prd1" guorong.zhang@enterprisedb.com < /tmp/check_pg-prd1.txt

[enterprisedb@pg-prd1 ~]$

-- while loop to check file size reach limit :

[enterprisedb@pg-prd1 ~]$ cat check_tmp_file_size.sh
#!/bin/bash


maxsize=100    # 100 kilobytes

while true; do
tmpfilestring=$(du -sh /var/data/base/pgsql_tmp | awk '{print $1}')
#tmpfilestring=$(du -sh /var/data/base | awk '{print $1}')
if [[ $(echo $tmpfilestring | grep G) ]];
then
  tmpfilesize=$(echo $tmpfilestring| sed 's/G//g')
    if [ $tmpfilesize -ge $maxsize ]; then
       # echo "temp file size is $tmpfilestring over $maxsize GB"
        echo " temp file size is $tmpfilestring over $maxsize GB" |mailx -s " temp file size is $tmpfilesize GB over $maxsize GB" guorong.zhang@enterprisedb.com
        exit
    else
        echo "temp file size is under $maxsize GB"
    fi
else
    echo "temp file size is $tmpfilestring under $maxsize GB"
fi
    sleep 300  # in seconds = 1 minutes
done


[enterprisedb@pg-prd1 ~]$ ./check_tmp_file_size.sh > /tmp/check_tmp_file_size.log 2>&1 &

[enterprisedb@pg-prd1 pg_log]$ grep " null value" enterprisedb-2017-12-05_192847.log
2017-12-05 20:04:31 EST [25911]: [16-1] user=postgres,db=data_warehouseERROR:  found unexpected null value in index "ix_t_1512522269_3680374922_key"
2017-12-05 20:06:47 EST [25911]: [23-1] user=postgres,db=data_warehouseERROR:  found unexpected null value in index "ix_t_1512522404_1090602559_key"

Error while publishing data for resource subset "QSI_Daily_": "(psycopg2.InternalError) found unexpected null value in index "ix_t_1512512991_4327073057_key"
 [SQL: 'UPDATE entity_master.perspective_entity_id_raw_v SET sys_effective_end_dt=%(sys_effective_end_dt)s, modified_dt=%(modified_dt)s, modified_by=%(modified_by)s FROM temp_data.t_1512512991_4327073057 WHERE (entity_master.perspective_entity_id_raw_v.perspective_entity_id_raw_key = temp_data.t_1512512991_4327073057.key) AND (entity_master.perspective_entity_id_raw_v.sys_effective_end_dt = to_timestamp(%(to_timestamp_1)s, %(to_timestamp_2)s)) AND (temp_data.t_1512512991_4327073057.data_status = %(param_1)s)'] [parameters: {'sys_effective_end_dt': datetime.datetime(2017, 12, 5, 17, 29, 51, 948851), 'modified_dt': datetime.datetime(2017, 12, 5, 17, 29, 52, 177509), 'modified_by': 'aristos', 'to_timestamp_1': '2079-12-31 23:59:59.999999', 'to_timestamp_2': 'YYYY-MM-DD HH24:MI:SS.US', 'param_1': 'M'}]"
INFO:root:Error while publishing data for resource subset "QSI_Daily_": "(psycopg2.InternalError) found unexpected null value in index "ix_t_1512512991_4327073057_key"
 [SQL: 'UPDATE entity_master.perspective_entity_id_raw_v SET sys_effective_end_dt=%(sys_effective_end_dt)s, modified_dt=%(modified_dt)s, modified_by=%(modified_by)s FROM temp_data.t_1512512991_4327073057 WHERE (entity_master.perspective_entity_id_raw_v.perspective_entity_id_raw_key = temp_data.t_1512512991_4327073057.key) AND (entity_master.perspective_entity_id_raw_v.sys_effective_end_dt = to_timestamp(%(to_timestamp_1)s, %(to_timestamp_2)s)) AND (temp_data.t_1512512991_4327073057.data_status = %(param_1)s)'] [parameters: {'sys_effective_end_dt': datetime.datetime(2017, 12, 5, 17, 29, 51, 948851), 'modified_dt': datetime.datetime(2017, 12, 5, 17, 29, 52, 177509), 'modified_by': 'aristos', 'to_timestamp_1': '2079-12-31 23:59:59.999999', 'to_timestamp_2': 'YYYY-MM-DD HH24:MI:SS.US', 'param_1': 'M'}]"
Traceback (most recent call last):
  File "/home/oa/anaconda3/envs/aristos/lib/python3.6/site-packages/sqlalchemy/engine/base.py", line 1182, in _execute_context
    context)
  File "/home/oa/anaconda3/envs/aristos/lib/python3.6/site-packages/sqlalchemy/engine/default.py", line 470, in do_execute
    cursor.execute(statement, parameters)
psycopg2.InternalError: found unexpected null value in index "ix_t_1512512991_4327073057_key"
 
 
The above exception was the direct cause of the following exception:
 
Traceback (most recent call last):
  File "/usr/local/aristos/source/oa/aristos/ingestion/publish_manager.py", line 405, in _process_resource_subset_inner
    result, res_subset_publishing_info)
  File "/usr/local/aristos/source/oa/aristos/ingestion/publish_manager.py", line 636, in _publish_pei_raw_data
    metadata_column_names=self._prep_utils.pei_prep_metadata_col_names, logger=self.manager, result=result)
  File "/usr/local/aristos/source/oa/aristos/common/rdbms_data.py", line 1807, in publish_data
    log_kwargs=log_kwargs, transaction=trans)
  File "/usr/local/aristos/source/oa/aristos/common/rdbms_data.py", line 1282, in update_entity_data
    transaction=trans)
  File "/usr/local/aristos/source/oa/aristos/common/rdbms_data.py", line 1486, in _end_current_version_data
    transaction=transaction)
  File "/usr/local/aristos/source/oa/aristos/core/resource_access/access_managers/rdbms_access.py", line 2522, in update
    add_default_metadata_column_values=add_default_metadata_column_values, transaction=transaction)
  File "/usr/local/aristos/source/oa/aristos/core/resource_access/access_managers/rdbms_access.py", line 3354, in update
    results = self.execute_statement(update_stmt, transaction=transaction)
  File "/usr/local/aristos/source/oa/aristos/core/resource_access/access_managers/rdbms_access.py", line 3507, in execute_statement
    output = self.execute_statement_inner(statement, data=data, transaction=transaction)
  File "/usr/local/aristos/source/oa/aristos/core/resource_access/access_managers/rdbms_access.py", line 3528, in execute_statement_inner
    output = transaction.execute(statement, data=data, autocommit=autocommit)
  File "/usr/local/aristos/source/oa/aristos/core/resource_access/access_managers/rdbms_access.py", line 5028, in execute
    output = self._connection.execute(statement, **kwargs)
  File "/home/oa/anaconda3/envs/aristos/lib/python3.6/site-packages/sqlalchemy/engine/base.py", line 945, in execute
    return meth(self, multiparams, params)
  File "/home/oa/anaconda3/envs/aristos/lib/python3.6/site-packages/sqlalchemy/sql/elements.py", line 263, in _execute_on_connection
    return connection._execute_clauseelement(self, multiparams, params)
  File "/home/oa/anaconda3/envs/aristos/lib/python3.6/site-packages/sqlalchemy/engine/base.py", line 1053, in _execute_clauseelement
    compiled_sql, distilled_params
  File "/home/oa/anaconda3/envs/aristos/lib/python3.6/site-packages/sqlalchemy/engine/base.py", line 1189, in _execute_context
    context)
  File "/home/oa/anaconda3/envs/aristos/lib/python3.6/site-packages/sqlalchemy/engine/base.py", line 1402, in _handle_dbapi_exception
    exc_info
  File "/home/oa/anaconda3/envs/aristos/lib/python3.6/site-packages/sqlalchemy/util/compat.py", line 203, in raise_from_cause
    reraise(type(exception), exception, tb=exc_tb, cause=cause)
  File "/home/oa/anaconda3/envs/aristos/lib/python3.6/site-packages/sqlalchemy/util/compat.py", line 186, in reraise
    raise value.with_traceback(tb)
  File "/home/oa/anaconda3/envs/aristos/lib/python3.6/site-packages/sqlalchemy/engine/base.py", line 1182, in _execute_context
    context)
  File "/home/oa/anaconda3/envs/aristos/lib/python3.6/site-packages/sqlalchemy/engine/default.py", line 470, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.InternalError: (psycopg2.InternalError) found unexpected null value in index "ix_t_1512512991_4327073057_key"
 [SQL: 'UPDATE entity_master.perspective_entity_id_raw_v SET sys_effective_end_dt=%(sys_effective_end_dt)s, modified_dt=%(modified_dt)s, modified_by=%(modified_by)s FROM temp_data.t_1512512991_4327073057 WHERE (entity_master.perspective_entity_id_raw_v.perspective_entity_id_raw_key = temp_data.t_1512512991_4327073057.key) AND (entity_master.perspective_entity_id_raw_v.sys_effective_end_dt = to_timestamp(%(to_timestamp_1)s, %(to_timestamp_2)s)) AND (temp_data.t_1512512991_4327073057.data_status = %(param_1)s)'] [parameters: {'sys_effective_end_dt': datetime.datetime(2017, 12, 5, 17, 29, 51, 948851), 'modified_dt': datetime.datetime(2017, 12, 5, 17, 29, 52, 177509), 'modified_by': 'aristos', 'to_timestamp_1': '2079-12-31 23:59:59.999999', 'to_timestamp_2': 'YYYY-MM-DD HH24:MI:SS.US', 'param_1': 'M'}]
INFO:root:Publishing of resource subset "QSI_Daily_" finished.
INFO:root:Publishing of data object "northern trust/nt port acct/OUTBOUND_QSI_Daily_/QSI_Daily_11022015190449.txt" finished.
 
 
select * from temp_data.t_1512512991_4327073057
;
select count(*) from temp_data.t_1512512991_4327073057 where key is null
;

data_warehouse=# \d temp_data.ix_t_1512512991_4327073057_key;
Index "temp_data.ix_t_1512512991_4327073057_key"
 Column |  Type   | Definition
--------+---------+------------
 key    | integer | key
unique, btree, for table "temp_data.t_1512512991_4327073057"

[enterprisedb@pg-prd1 pg_log]$ grep t_1512512991_4327073057 * -B 2  -A 2
enterprisedb-2017-12-05_000000.log-     system usage: CPU 0.00s/0.00u sec elapsed 0.00 sec
enterprisedb-2017-12-05_000000.log-2017-12-05 17:29:52 EST [28401]: [4-1] user=,db=LOG:  automatic analyze of table "data_warehouse.temp_data.t_1512512990_2844906192" system usage: CPU 0.00s/0.00u sec elapsed 0.00 sec
enterprisedb-2017-12-05_000000.log:2017-12-05 17:29:52 EST [28401]: [5-1] user=,db=LOG:  automatic analyze of table "data_warehouse.temp_data.t_1512512991_4327073057" system usage: CPU 0.00s/0.01u sec elapsed 0.01 sec
enterprisedb-2017-12-05_000000.log-2017-12-05 17:29:52 EST [28401]: [6-1] user=,db=LOG:  automatic vacuum of table "data_warehouse.temp_data.t_1512512990_9641426171": index scans: 1
enterprisedb-2017-12-05_000000.log-     pages: 0 removed, 10 remain, 0 skipped due to pins, 0 skipped frozen
--
enterprisedb-2017-12-05_000000.log-2017-12-05 17:29:52 EST [28401]: [8-1] user=,db=LOG:  automatic analyze of table "data_warehouse.temp_data.t_1512511976_6806000232" system usage: CPU 0.00s/0.00u sec elapsed 0.00 sec
enterprisedb-2017-12-05_000000.log-2017-12-05 17:29:52 EST [28401]: [9-1] user=,db=LOG:  automatic analyze of table "data_warehouse.temp_data.t_1512511976_8054387408" system usage: CPU 0.00s/0.01u sec elapsed 0.01 sec
enterprisedb-2017-12-05_000000.log:2017-12-05 17:29:52 EST [20680]: [1-1] user=postgres,db=data_warehouseERROR:  found unexpected null value in index "ix_t_1512512991_4327073057_key"
enterprisedb-2017-12-05_000000.log:2017-12-05 17:29:52 EST [20680]: [2-1] user=postgres,db=data_warehouseSTATEMENT:  UPDATE entity_master.perspective_entity_id_raw_v SET sys_effective_end_dt='2017-12-05T17:29:51.948851'::timestamp, modified_dt='2017-12-05T17:29:52.177509'::timestamp, modified_by='aristos' FROM temp_data.t_1512512991_4327073057 WHERE (entity_master.perspective_entity_id_raw_v.perspective_entity_id_raw_key = temp_data.t_1512512991_4327073057.key) AND (entity_master.perspective_entity_id_raw_v.sys_effective_end_dt = to_timestamp('2079-12-31 23:59:59.999999', 'YYYY-MM-DD HH24:MI:SS.US')) AND (temp_data.t_1512512991_4327073057.data_status = 'M')
enterprisedb-2017-12-05_000000.log:2017-12-05 17:29:56 EST [28506]: [1-1] user=,db=LOG:  automatic vacuum of table "data_warehouse.temp_data.t_1512512991_4327073057": index scans: 1
enterprisedb-2017-12-05_000000.log-     pages: 0 removed, 139 remain, 0 skipped due to pins, 0 skipped frozen
enterprisedb-2017-12-05_000000.log-     tuples: 1583 removed, 1715 remain, 0 are dead but not yet removable
--
enterprisedb-2017-12-05_000000.log-     avg read rate: 6.226 MB/s, avg write rate: 6.848 MB/s
enterprisedb-2017-12-05_000000.log-     system usage: CPU 0.00s/0.00u sec elapsed 0.01 sec
enterprisedb-2017-12-05_000000.log:2017-12-05 17:29:56 EST [28506]: [2-1] user=,db=LOG:  automatic analyze of table "data_warehouse.temp_data.t_1512512991_4327073057" system usage: CPU 0.00s/0.01u sec elapsed 0.03 sec
enterprisedb-2017-12-05_000000.log-2017-12-05 17:29:56 EST [28506]: [3-1] user=,db=LOG:  automatic analyze of table "data_warehouse.temp_data.t_1512511976_7464881216" system usage: CPU 0.00s/0.01u sec elapsed 0.01 sec
enterprisedb-2017-12-05_000000.log-2017-12-05 17:29:56 EST [28506]: [4-1] user=,db=LOG:  automatic vacuum of table "data_warehouse.temp_data.t_1512512996_8839053675": index scans: 0
grep: temp_xlog: Is a directory
[enterprisedb@pg-prd1 pg_log]$

==================

-- check 

entity_master.perspective_entity_id_raw_v.perspective_entity_id_raw_key = temp_data.t_1512512991_4327073057.key


data_warehouse=# \d entity_master.perspective_entity_id_raw_v
                                                         Table "entity_master.perspective_entity_id_raw_v"
             Column             |            Type             |                                              Modifiers
--------------------------------+-----------------------------+-----------------------------------------------------------------------------------------------------
 key                            | bigint                      | not null default nextval('entity_master.sq_perspective_entity_id_raw_v'::regclass)
 perspective_entity_id_raw_key  | bigint                      | not null
 perspective_key                | integer                     | not null
 perspective_entity_key         | bigint                      | not null
 identifier_type_key            | integer                     | not null
 identifier_value               | character varying(125)      | not null
 is_primary                     | boolean                     | not null
 effective_start_dt             | timestamp without time zone | not null
 effective_end_dt               | timestamp without time zone | not null
 effective_start_dt_is_estimate | boolean                     | not null
 effective_end_dt_is_estimate   | boolean                     | not null
 data_row_id                    | integer                     | not null
 data_object_proc_result_key    | integer                     | not null
 data_hash                      | character varying(32)       | not null
 resource_subset_key            | integer                     | not null
 data_object_key                | integer                     | not null
 data_object_data_effective_dt  | timestamp without time zone |
 sys_effective_start_dt         | timestamp without time zone | not null default now()
 sys_effective_end_dt           | timestamp without time zone | not null default to_timestamp('2079-12-31 23:59:59.999999'::text, 'YYYY-MM-DD HH24:MI:SS.US'::text)
 created_dt                     | timestamp without time zone | not null default now()
 created_by                     | character varying(100)      | not null
 modified_dt                    | timestamp without time zone | not null default now()
 modified_by                    | character varying(100)      | not null
Indexes:
    "pk_perspective_entity_id_raw_v_" PRIMARY KEY, btree (key)
    "ix_perspective_entity_id_raw_2" btree (identifier_value, identifier_type_key, effective_start_dt, effective_end_dt)
    "ix_perspective_entity_id_raw_3" btree (modified_dt, perspective_entity_key)
    "ix_perspective_entity_id_raw_4" btree (data_object_key, resource_subset_key)
    "ix_perspective_entity_id_raw_5" btree (data_hash, data_object_key)
    "ix_perspective_entity_id_raw_v_me" btree (perspective_entity_id_raw_key, sys_effective_end_dt)

data_warehouse=# \d temp_data.t_1512512991_4327073057
                Table "temp_data.t_1512512991_4327073057"
             Column             |            Type             | Modifiers
--------------------------------+-----------------------------+-----------
 data_hash                      | character varying(32)       |
 data_row_id                    | integer                     |
 data_object_proc_result_key    | integer                     |
 resource_subset_key            | integer                     |
 data_object_key                | integer                     |
 data_object_data_effective_dt  | timestamp without time zone |
 pe_perspective_key             | integer                     |
 pe_entity_type_key             | integer                     |
 pe_identifier_type_key         | integer                     |
 pe_identifier_value            | character varying(125)      |
 identifier_type_key            | integer                     |
 identifier_value               | character varying(125)      |
 is_primary                     | boolean                     |
 effective_start_dt             | timestamp without time zone |
 effective_end_dt               | timestamp without time zone |
 effective_start_dt_is_estimate | boolean                     |
 effective_end_dt_is_estimate   | boolean                     |
 data_status                    | character varying(1)        |
 key                            | integer                     |
 perspective_entity_key         | integer                     |
 perspective_key                | integer                     |
Indexes:
    "ix_t_1512512991_4327073057_key" UNIQUE, btree (key)
    "ix_t_1512512991_4327073057_keyds" UNIQUE, btree (data_status, key)

1: entity_master.perspective_entity_id_raw_v.perspective_entity_id_raw_key  | bigint      | not null
    no index just for this column
2: temp_data.t_1512512991_4327073057.key key                            | integer                     
     index ix_t_1512512991_4327073057_key" UNIQUE, btree (key) --> this means it could be null.
   =================================
   enterprisedb-2017-12-05_192847.log-2017-12-05 21:58:42 EST [25969]: [1-1] user=postgres,db=data_warehouseLOG:  duration: 1013.905 ms  statement: 
   UPDATE entity_master.perspective_entity_id_raw 
   SET data_row_id=temp_data.t_1512529119_1931780163.data_row_id, data_object_proc_result_key=temp_data.t_1512529119_1931780163.data_object_proc_result_key, data_hash=temp_data.t_1512529119_1931780163.data_hash, 
 resource_subset_key=temp_data.t_1512529119_1931780163.resource_subset_key, data_object_key=temp_data.t_1512529119_1931780163.data_object_key, data_object_data_effective_dt=temp_data.t_1512529119_1931780163.data_object_data_effective_dt, 
 sys_effective_start_dt='2017-12-05T21:58:41.462996'::timestamp, sys_effective_end_dt='2079-12-31T23:59:59.999999'::timestamp,  modified_dt='2017-12-05T21:58:41.478028'::timestamp, modified_by='aristos' FROM temp_data.t_1512529119_1931780163
 WHERE (entity_master.perspective_entity_id_raw.key = temp_data.t_1512529119_1931780163.key) 
 AND (temp_data.t_1512529119_1931780163.data_status = 'M')
 
enterprisedb-2017-12-05_192847.log:2017-12-05 21:58:42 EST [25969]: [2-1] user=postgres,db=data_warehouseERROR:  found unexpected null value in index "ix_t_1512529119_1931780163_key"
enterprisedb-2017-12-05_192847.log-2017-12-05 21:58:42 EST [25969]: [3-1] user=postgres,db=data_warehouseSTATEMENT: 
UPDATE entity_master.perspective_entity_id_raw_v 
SET sys_effective_end_dt='2017-12-05T21:58:41.462996'::timestamp, 
modified_dt='2017-12-05T21:58:42.497806'::timestamp, 
modified_by='aristos' FROM temp_data.t_1512529119_1931780163 
WHERE (entity_master.perspective_entity_id_raw_v.perspective_entity_id_raw_key = temp_data.t_1512529119_1931780163.key) 
AND (entity_master.perspective_entity_id_raw_v.sys_effective_end_dt = to_timestamp('2079-12-31 23:59:59.999999', 'YYYY-MM-DD HH24:MI:SS.US')) AND (temp_data.t_1512529119_1931780163.data_status = 'M')
============================================
enterprisedb-2017-11-30_081253.log:2017-11-30 10:13:02 EST [7078]: [16-1] user=postgres,db=data_warehouseERROR:  found unexpected null value in index "ix_t_1512054700_3896450134_key"

enterprisedb-2017-12-03_184452.log:2017-12-03 19:48:45 EST [1478]: [40-1] user=postgres,db=data_warehouseERROR:  found unexpected null value in index "ix_t_1512348420_9372931989_key"
enterprisedb-2017-12-05_000000.log:2017-12-05 00:50:05 EST [19473]: [1-1] user=postgres,db=data_warehouseERROR:  found unexpected null value in index "ix_t_1512453005_88970020_key"
enterprisedb-2017-12-05_000000.log:2017-12-05 00:56:32 EST [22095]: [1-1] user=postgres,db=data_warehouseERROR:  found unexpected null value in index "ix_t_1512453391_9046537025_key"
enterprisedb-2017-12-05_000000.log:2017-12-05 17:29:52 EST [20680]: [1-1] user=postgres,db=data_warehouseERROR:  found unexpected null value in index "ix_t_1512512991_4327073057_key"
enterprisedb-2017-12-05_000000.log:2017-12-05 17:34:41 EST [32130]: [1-1] user=postgres,db=data_warehouseERROR:  found unexpected null value in index "ix_t_1512513279_517128066_key"
enterprisedb-2017-12-05_000000.log:2017-12-05 18:49:55 EST [3806]: [2-1] user=postgres,db=data_warehouseERROR:  found unexpected null value in index "ix_t_1512517790_9263713003_key"
enterprisedb-2017-12-05_000000.log:2017-12-05 18:51:34 EST [3806]: [22-1] user=postgres,db=data_warehouseERROR:  found unexpected null value in index "ix_t_1512517889_9546850689_key"
enterprisedb-2017-12-05_192847.log:2017-12-05 20:04:31 EST [25911]: [16-1] user=postgres,db=data_warehouseERROR:  found unexpected null value in index "ix_t_1512522269_3680374922_key"
enterprisedb-2017-12-05_192847.log:2017-12-05 20:06:47 EST [25911]: [23-1] user=postgres,db=data_warehouseERROR:  found unexpected null value in index "ix_t_1512522404_1090602559_key"
enterprisedb-2017-12-05_192847.log:2017-12-05 21:58:42 EST [25969]: [2-1] user=postgres,db=data_warehouseERROR:  found unexpected null value in index "ix_t_1512529119_1931780163_key"
grep: temp_xlog: Is a directory
==========================
+++++++++++++++++++++++++++++
2017-12-06

data_warehouse=# select count(*) from entity_master.perspective_entity_id_raw_v e,temp_data.t_1512512991_4327073057 t where e.perspective_entity_id_raw_key=t.key;
 count
-------
 88410
(1 row)

data_warehouse=# explain select count(*) from entity_master.perspective_entity_id_raw_v e,temp_data.t_1512512991_4327073057 t where e.perspective_entity_id_raw_key=t.key;
                                                               QUERY PLAN
-----------------------------------------------------------------------------------------------------------------------------------------
 Aggregate  (cost=15491.15..15491.18 rows=1 width=8)
   ->  Nested Loop  (cost=0.85..15419.34 rows=28722 width=0)
         ->  Index Only Scan using ix_t_1512512991_4327073057_keyds on t_1512512991_4327073057 t  (cost=0.28..74.30 rows=1715 width=4)
         ->  Index Only Scan using ix_perspective_entity_id_raw_v_me on perspective_entity_id_raw_v e  (cost=0.57..8.44 rows=17 width=8)
               Index Cond: (perspective_entity_id_raw_key = t.key)
(5 rows)

data_warehouse=# \d temp_data.ix_t_1512512991_4327073057_keyds
Index "temp_data.ix_t_1512512991_4327073057_keyds"
   Column    |         Type         | Definition
-------------+----------------------+-------------
 data_status | character varying(1) | data_status
 key         | integer              | key
unique, btree, for table "temp_data.t_1512512991_4327073057"

data_warehouse=# \d  temp_data.ix_t_1512512991_4327073057;
Did not find any relation named "temp_data.ix_t_1512512991_4327073057".
data_warehouse=# \d  temp_data.t_1512512991_4327073057;
                Table "temp_data.t_1512512991_4327073057"
             Column             |            Type             | Modifiers
--------------------------------+-----------------------------+-----------
 data_hash                      | character varying(32)       |
 data_row_id                    | integer                     |
 data_object_proc_result_key    | integer                     |
 resource_subset_key            | integer                     |
 data_object_key                | integer                     |
 data_object_data_effective_dt  | timestamp without time zone |
 pe_perspective_key             | integer                     |
 pe_entity_type_key             | integer                     |
 pe_identifier_type_key         | integer                     |
 pe_identifier_value            | character varying(125)      |
 identifier_type_key            | integer                     |
 identifier_value               | character varying(125)      |
 is_primary                     | boolean                     |
 effective_start_dt             | timestamp without time zone |
 effective_end_dt               | timestamp without time zone |
 effective_start_dt_is_estimate | boolean                     |
 effective_end_dt_is_estimate   | boolean                     |
 data_status                    | character varying(1)        |
 key                            | integer                     |
 perspective_entity_key         | integer                     |
 perspective_key                | integer                     |
Indexes:
    "ix_t_1512512991_4327073057_key" UNIQUE, btree (key)
    "ix_t_1512512991_4327073057_keyds" UNIQUE, btree (data_status, key)

data_warehouse=#
2017-12-06 db log"

enterprisedb-2017-12-06_000000.log-2017-12-06 01:14:42 EST [26484]: [1-1] user=,db=LOG:  automatic analyze of table "data_warehouse.temp_data.t_1512540881_2240253925" system usage: CPU 0.00s/0.07u sec elapsed 0.09 sec
enterprisedb-2017-12-06_000000.log-2017-12-06 01:14:42 EST [26484]: [2-1] user=,db=LOG:  automatic analyze of table "data_warehouse.temp_data.t_1512540882_6053338518" system usage: CPU 0.00s/0.00u sec elapsed 0.00 sec
enterprisedb-2017-12-06_000000.log:2017-12-06 01:14:42 EST [26365]: [1-1] user=postgres,db=data_warehouseERROR:  found unexpected null value in index "ix_t_1512540882_6053338518_key"
enterprisedb-2017-12-06_000000.log-2017-12-06 01:14:42 EST [26365]: [2-1] user=postgres,db=data_warehouseSTATEMENT:  UPDATE entity_master.perspective_entity_id_raw SET data_row_id=temp_data.t_1512540882_6053338518.data_row_id, data_object_proc_result_key=temp_data.t_1512540882_6053338518.data_object_proc_result_key, data_hash=temp_data.t_1512540882_6053338518.data_hash, resource_subset_key=temp_data.t_1512540882_6053338518.resource_subset_key, data_object_key=temp_data.t_1512540882_6053338518.data_object_key, data_object_data_effective_dt=temp_data.t_1512540882_6053338518.data_object_data_effective_dt, sys_effective_start_dt='2017-12-06T01:14:42.938918'::timestamp, sys_effective_end_dt='2079-12-31T23:59:59.999999'::timestamp, modified_dt='2017-12-06T01:14:42.946245'::timestamp, modified_by='aristos' FROM temp_data.t_1512540882_6053338518 WHERE (entity_master.perspective_entity_id_raw.key = temp_data.t_1512540882_6053338518.key) AND (temp_data.t_1512540882_6053338518.data_status = 'M')
enterprisedb-2017-12-06_000000.log-2017-12-06 01:14:47 EST [26509]: [1-1] user=,db=LOG:  automatic vacuum of table "data_warehouse.temp_data.t_1512540882_6053338518": index scans: 1
--
enterprisedb-2017-12-06_000000.log-2017-12-06 01:35:55 EST [32965]: [1-1] user=,db=LOG:  automatic analyze of table "data_warehouse.temp_data.t_1512542153_3771819926" system usage: CPU 0.00s/0.06u sec elapsed 0.07 sec
enterprisedb-2017-12-06_000000.log-2017-12-06 01:35:55 EST [32965]: [2-1] user=,db=LOG:  automatic analyze of table "data_warehouse.temp_data.t_1512542154_5338551772" system usage: CPU 0.00s/0.00u sec elapsed 0.00 sec
enterprisedb-2017-12-06_000000.log:2017-12-06 01:35:55 EST [32855]: [1-1] user=postgres,db=data_warehouseERROR:  found unexpected null value in index "ix_t_1512542154_5338551772_key"
enterprisedb-2017-12-06_000000.log-2017-12-06 01:35:55 EST [32855]: [2-1] user=postgres,db=data_warehouseSTATEMENT:  UPDATE entity_master.perspective_entity_id_raw SET data_row_id=temp_data.t_1512542154_5338551772.data_row_id, data_object_proc_result_key=temp_data.t_1512542154_5338551772.data_object_proc_result_key, data_hash=temp_data.t_1512542154_5338551772.data_hash, resource_subset_key=temp_data.t_1512542154_5338551772.resource_subset_key, data_object_key=temp_data.t_1512542154_5338551772.data_object_key, data_object_data_effective_dt=temp_data.t_1512542154_5338551772.data_object_data_effective_dt, sys_effective_start_dt='2017-12-06T01:35:55.609009'::timestamp, sys_effective_end_dt='2079-12-31T23:59:59.999999'::timestamp, modified_dt='2017-12-06T01:35:55.625627'::timestamp, modified_by='aristos' FROM temp_data.t_1512542154_5338551772 WHERE (entity_master.perspective_entity_id_raw.key = temp_data.t_1512542154_5338551772.key) AND (temp_data.t_1512542154_5338551772.data_status = 'M')
enterprisedb-2017-12-06_000000.log-2017-12-06 01:36:05 EST [32981]: [1-1] user=,db=LOG:  automatic vacuum of table "data_warehouse.pg_catalog.pg_attribute": index scans: 1
--
enterprisedb-2017-12-06_000000.log-2017-12-06 02:13:49 EST [11166]: [1-1] user=,db=LOG:  automatic analyze of table "data_warehouse.temp_data.t_1512544427_5055994123" system usage: CPU 0.00s/0.05u sec elapsed 0.06 sec
enterprisedb-2017-12-06_000000.log-2017-12-06 02:13:49 EST [11166]: [2-1] user=,db=LOG:  automatic analyze of table "data_warehouse.temp_data.t_1512544428_4836693509" system usage: CPU 0.00s/0.00u sec elapsed 0.00 sec
enterprisedb-2017-12-06_000000.log:2017-12-06 02:13:49 EST [11093]: [1-1] user=postgres,db=data_warehouseERROR:  found unexpected null value in index "ix_t_1512544428_4836693509_key"
enterprisedb-2017-12-06_000000.log-2017-12-06 02:13:49 EST [11093]: [2-1] user=postgres,db=data_warehouseSTATEMENT:  UPDATE entity_master.perspective_entity_id_raw SET data_row_id=temp_data.t_1512544428_4836693509.data_row_id, data_object_proc_result_key=temp_data.t_1512544428_4836693509.data_object_proc_result_key, data_hash=temp_data.t_1512544428_4836693509.data_hash, resource_subset_key=temp_data.t_1512544428_4836693509.resource_subset_key, data_object_key=temp_data.t_1512544428_4836693509.data_object_key, data_object_data_effective_dt=temp_data.t_1512544428_4836693509.data_object_data_effective_dt, sys_effective_start_dt='2017-12-06T02:13:49.502478'::timestamp, sys_effective_end_dt='2079-12-31T23:59:59.999999'::timestamp, modified_dt='2017-12-06T02:13:49.508392'::timestamp, modified_by='aristos' FROM temp_data.t_1512544428_4836693509 WHERE (entity_master.perspective_entity_id_raw.key = temp_data.t_1512544428_4836693509.key) AND (temp_data.t_1512544428_4836693509.data_status = 'M')
enterprisedb-2017-12-06_000000.log-2017-12-06 02:13:54 EST [11193]: [1-1] user=,db=LOG:  automatic vacuum of table "data_warehouse.temp_data.t_1512544428_4836693509": index scans: 1
--
enterprisedb-2017-12-06_000000.log-2017-12-06 05:40:01 EST [1749]: [2-1] user=,db=LOG:  automatic analyze of table "data_warehouse.temp_data.t_1512556791_4832405278" system usage: CPU 0.00s/0.15u sec elapsed 0.18 sec
enterprisedb-2017-12-06_000000.log-2017-12-06 05:40:16 EST [30778]: [57-1] user=postgres,db=data_warehouseLOG:  duration: 17582.994 ms  statement: UPDATE entity_master.perspective_entity_id_raw SET data_row_id=temp_data.t_1512556791_4832405278.data_row_id, data_object_proc_result_key=temp_data.t_1512556791_4832405278.data_object_proc_result_key, data_hash=temp_data.t_1512556791_4832405278.data_hash, resource_subset_key=temp_data.t_1512556791_4832405278.resource_subset_key, data_object_key=temp_data.t_1512556791_4832405278.data_object_key, data_object_data_effective_dt=temp_data.t_1512556791_4832405278.data_object_data_effective_dt, sys_effective_start_dt='2017-12-06T05:39:59.252833'::timestamp, sys_effective_end_dt='2079-12-31T23:59:59.999999'::timestamp, modified_dt='2017-12-06T05:39:59.268669'::timestamp, modified_by='aristos' FROM temp_data.t_1512556791_4832405278 WHERE (entity_master.perspective_entity_id_raw.key = temp_data.t_1512556791_4832405278.key) AND (temp_data.t_1512556791_4832405278.data_status = 'M')
enterprisedb-2017-12-06_000000.log:2017-12-06 05:40:16 EST [30778]: [58-1] user=postgres,db=data_warehouseERROR:  found unexpected null value in index "ix_t_1512556791_4832405278_key"
enterprisedb-2017-12-06_000000.log-2017-12-06 05:40:16 EST [30778]: [59-1] user=postgres,db=data_warehouseSTATEMENT:  UPDATE entity_master.perspective_entity_id_raw_v SET sys_effective_end_dt='2017-12-06T05:39:59.252833'::timestamp, modified_dt='2017-12-06T05:40:16.855337'::timestamp, modified_by='aristos' FROM temp_data.t_1512556791_4832405278 WHERE (entity_master.perspective_entity_id_raw_v.perspective_entity_id_raw_key = temp_data.t_1512556791_4832405278.key) AND (entity_master.perspective_entity_id_raw_v.sys_effective_end_dt = to_timestamp('2079-12-31 23:59:59.999999', 'YYYY-MM-DD HH24:MI:SS.US')) AND (temp_data.t_1512556791_4832405278.data_status = 'M')
enterprisedb-2017-12-06_000000.log-2017-12-06 05:40:25 EST [1902]: [1-1] user=,db=LOG:  automatic vacuum of table "data_warehouse.temp_data.t_1512556824_6998881490": index scans: 1
--
enterprisedb-2017-12-06_000000.log-     system usage: CPU 0.00s/0.00u sec elapsed 0.00 sec
enterprisedb-2017-12-06_000000.log-2017-12-06 05:42:18 EST [3054]: [9-1] user=,db=LOG:  automatic analyze of table "data_warehouse.temp_data.t_1512556937_637962169" system usage: CPU 0.00s/0.00u sec elapsed 0.00 sec
enterprisedb-2017-12-06_000000.log:2017-12-06 05:42:18 EST [2646]: [2-1] user=postgres,db=data_warehouseERROR:  found unexpected null value in index "ix_t_1512556937_637962169_key"
enterprisedb-2017-12-06_000000.log-2017-12-06 05:42:18 EST [2646]: [3-1] user=postgres,db=data_warehouseSTATEMENT:  INSERT INTO entity_master.perspective_entity_id_raw_v (key, perspective_entity_id_raw_key, perspective_key, perspective_entity_key, identifier_type_key, identifier_value, is_primary, effective_start_dt, effective_end_dt, effective_start_dt_is_estimate, effective_end_dt_is_estimate, data_row_id, data_object_proc_result_key, data_hash, resource_subset_key, data_object_key, data_object_data_effective_dt, sys_effective_start_dt, sys_effective_end_dt, created_dt, created_by, modified_dt, modified_by) SELECT nextval('entity_master.sq_perspective_entity_id_raw_v') AS key, entity_master.perspective_entity_id_raw.key AS perspective_entity_id_raw_key, entity_master.perspective_entity_id_raw.perspective_key, entity_master.perspective_entity_id_raw.perspective_entity_key, entity_master.perspective_entity_id_raw.identifier_type_key, entity_master.perspective_entity_id_raw.identifier_value, entity_master.perspective_entity_id_raw.is_primary, entity_master.perspective_entity_id_raw.effective_start_dt, entity_master.perspective_entity_id_raw.effective_end_dt, entity_master.perspective_entity_id_raw.effective_start_dt_is_estimate, entity_master.perspective_entity_id_raw.effective_end_dt_is_estimate, entity_master.perspective_entity_id_raw.data_row_id, entity_master.perspective_entity_id_raw.data_object_proc_result_key, entity_master.perspective_entity_id_raw.data_hash, entity_master.perspective_entity_id_raw.resource_subset_key, entity_master.perspective_entity_id_raw.data_object_key, entity_master.perspective_entity_id_raw.data_object_data_effective_dt, entity_master.perspective_entity_id_raw.sys_effective_start_dt, entity_master.perspective_entity_id_raw.sys_effective_end_dt, entity_master.perspective_entity_id_raw.created_dt, entity_master.perspective_entity_id_raw.created_by, entity_master.perspective_entity_id_raw.modified_dt, entity_master.perspective_entity_id_raw.modified_by
enterprisedb-2017-12-06_000000.log-     FROM temp_data.t_1512556937_637962169 JOIN entity_master.perspective_entity_id_raw ON (entity_master.perspective_entity_id_raw.key = temp_data.t_1512556937_637962169.key) AND (temp_data.t_1512556937_637962169.data_status = 'M')
--
enterprisedb-2017-12-06_000000.log-2017-12-06 06:09:10 EST [13742]: [7-1] user=,db=LOG:  automatic analyze of table "data_warehouse.temp_data.t_1512558537_2931555787" system usage: CPU 0.00s/0.00u sec elapsed 0.00 sec
enterprisedb-2017-12-06_000000.log-2017-12-06 06:09:10 EST [13742]: [8-1] user=,db=LOG:  automatic analyze of table "data_warehouse.temp_data.t_1512558537_5172418088" system usage: CPU 0.00s/0.01u sec elapsed 0.01 sec
enterprisedb-2017-12-06_000000.log:2017-12-06 06:09:10 EST [13713]: [1-1] user=postgres,db=data_warehouseERROR:  found unexpected null value in index "ix_t_1512558549_936128822_key"
enterprisedb-2017-12-06_000000.log-2017-12-06 06:09:10 EST [13713]: [2-1] user=postgres,db=data_warehouseSTATEMENT:  UPDATE entity_master.perspective_entity_id_raw SET data_row_id=temp_data.t_1512558549_936128822.data_row_id, data_object_proc_result_key=temp_data.t_1512558549_936128822.data_object_proc_result_key, data_hash=temp_data.t_1512558549_936128822.data_hash, resource_subset_key=temp_data.t_1512558549_936128822.resource_subset_key, data_object_key=temp_data.t_1512558549_936128822.data_object_key, data_object_data_effective_dt=temp_data.t_1512558549_936128822.data_object_data_effective_dt, sys_effective_start_dt='2017-12-06T06:09:10.338921'::timestamp, sys_effective_end_dt='2079-12-31T23:59:59.999999'::timestamp, modified_dt='2017-12-06T06:09:10.350578'::timestamp, modified_by='aristos' FROM temp_data.t_1512558549_936128822 WHERE (entity_master.perspective_entity_id_raw.key = temp_data.t_1512558549_936128822.key) AND (temp_data.t_1512558549_936128822.data_status = 'M')
enterprisedb-2017-12-06_000000.log-2017-12-06 06:09:14 EST [13749]: [1-1] user=postgres,db=data_warehouseLOG:  duration: 1012.162 ms  statement: UPDATE temp_data.t_1512558552_8517900893 SET data_status=CASE WHEN (temp_data.t_1512558552_8517900893.data_hash = entity_master.perspective_entity_id_raw.data_hash) THEN 'M' ELSE 'D' END, key=entity_master.perspective_entity_id_raw.key FROM entity_master.perspective_entity_id_raw WHERE temp_data.t_1512558552_8517900893.data_hash = entity_master.perspective_entity_id_raw.data_hash
--
enterprisedb-2017-12-06_000000.log-2017-12-06 08:18:04 EST [22494]: [4-1] user=,db=LOG:  automatic analyze of table "data_warehouse.temp_data.t_1512566283_4717894886" system usage: CPU 0.00s/0.04u sec elapsed 0.04 sec
enterprisedb-2017-12-06_000000.log-2017-12-06 08:18:04 EST [22494]: [5-1] user=,db=LOG:  automatic analyze of table "data_warehouse.temp_data.t_1512566275_9645007915" system usage: CPU 0.00s/0.01u sec elapsed 0.01 sec
enterprisedb-2017-12-06_000000.log:2017-12-06 08:18:04 EST [22460]: [1-1] user=postgres,db=data_warehouseERROR:  found unexpected null value in index "ix_t_1512566283_4717894886_key"
enterprisedb-2017-12-06_000000.log-2017-12-06 08:18:04 EST [22460]: [2-1] user=postgres,db=data_warehouseSTATEMENT:  UPDATE entity_master.perspective_entity_id_raw SET data_row_id=temp_data.t_1512566283_4717894886.data_row_id, data_object_proc_result_key=temp_data.t_1512566283_4717894886.data_object_proc_result_key, data_hash=temp_data.t_1512566283_4717894886.data_hash, resource_subset_key=temp_data.t_1512566283_4717894886.resource_subset_key, data_object_key=temp_data.t_1512566283_4717894886.data_object_key, data_object_data_effective_dt=temp_data.t_1512566283_4717894886.data_object_data_effective_dt, sys_effective_start_dt='2017-12-06T08:18:04.325082'::timestamp, sys_effective_end_dt='2079-12-31T23:59:59.999999'::timestamp, modified_dt='2017-12-06T08:18:04.336414'::timestamp, modified_by='aristos' FROM temp_data.t_1512566283_4717894886 WHERE (entity_master.perspective_entity_id_raw.key = temp_data.t_1512566283_4717894886.key) AND (temp_data.t_1512566283_4717894886.data_status = 'M')
enterprisedb-2017-12-06_000000.log-2017-12-06 08:18:04 EST [22494]: [6-1] user=,db=LOG:  automatic vacuum of table "data_warehouse.temp_data.t_1512566282_8388288909": index scans: 1
======================
 UPDATE entity_master.perspective_entity_id_raw_v SET sys_effective_end_dt='2017-12-06T11:17:32.777057'::timestamp, modified_dt='2017-12-06T11:18:54.578739'::timestamp, modified_by='aris
tos' FROM temp_data.t_1512576964_1647238568 WHERE (entity_master.perspective_entity_id_raw_v.perspective_entity_id_raw_key = temp_data.t_1512576964_1647238568.key) AND (entity_master.perspective_entity_id
_raw_v.sys_effective_end_dt = to_timestamp('2079-12-31 23:59:59.999999', 'YYYY-MM-DD HH24:MI:SS.US')) AND (temp_data.t_1512576964_1647238568.data_status = 'M')

# Troubleshooting in postgresql.conf at pg-prd1:

log_min_duration_statement = 0
log_checkpoints = off
log_autovacuum_min_duration = -1
[enterprisedb@pg-prd1 data]$

pg_ctl -D $PGDATA reload at 2017-12-06 8:45PM to enable statements detail on pg-prd1

start data process at 8:45PM
-- check log at 10:55PM
enterprisedb-2017-12-06_171058.log:2017-12-06 17:10:59 EST [1119]: [34-1] user=postgres,db=aristos_metadataERROR:  null value in column "created_by" violates not-null constraint
enterprisedb-2017-12-06_171058.log-2017-12-06 17:10:59 EST [1119]: [35-1] user=postgres,db=aristos_metadataDETAIL:  Failing row contains (119774, 34297, 6211, 3, f, t, null, ["Processing task result for element \"RealEstate_EAP_LTMYTD_201..., [], [], 2017-12-06 17:06:21.648802, 2017-12-06 17:10:59.148911, 2017-12-06 17:10:59.66348, null, 2017-12-06 17:10:59.66348, aristos).
enterprisedb-2017-12-06_171058.log-2017-12-06 17:10:59 EST [1119]: [36-1] user=postgres,db=aristos_metadataSTATEMENT:  INSERT INTO public.data_object_processing_result (data_object_key, task_execution_key, task_exec_status_key, processing_occurred, has_errors, has_warnings, error_messages, warning_messages, info_messages, processing_start_dt, processing_end_dt, modified_dt, modified_by) VALUES (34297, 6211, 3, false, true, NULL, '["Processing task result for element \"RealEstate_EAP_LTMYTD_20171205_1.zip\" was incorrectly ended."]', '[]', '[]', '2017-12-06T17:06:21.648802'::timestamp, '2017-12-06T17:10:59.148911'::timestamp, now(), 'aristos') RETURNING public.data_object_processing_result.key
--
enterprisedb-2017-12-06_171058.log-     system usage: CPU 0.00s/0.01u sec elapsed 0.08 sec
enterprisedb-2017-12-06_171058.log-2017-12-06 17:37:16 EST [12062]: [9-1] user=,db=LOG:  automatic analyze of table "data_warehouse.temp_data.t_1512599834_6677622796" system usage: CPU 0.00s/0.10u sec elapsed 0.13 sec
enterprisedb-2017-12-06_171058.log:2017-12-06 17:37:16 EST [12056]: [1-1] user=postgres,db=data_warehouseERROR:  found unexpected null value in index "ix_t_1512599834_6677622796_key"
enterprisedb-2017-12-06_171058.log-2017-12-06 17:37:16 EST [12056]: [2-1] user=postgres,db=data_warehouseSTATEMENT:  UPDATE entity_master.perspective_entity_id_raw_v SET sys_effective_end_dt='2017-12-06T17:37:16.012345'::timestamp, modified_dt='2017-12-06T17:37:16.851291'::timestamp, modified_by='aristos' FROM temp_data.t_1512599834_6677622796 WHERE (entity_master.perspective_entity_id_raw_v.perspective_entity_id_raw_key = temp_data.t_1512599834_6677622796.key) AND (entity_master.perspective_entity_id_raw_v.sys_effective_end_dt = to_timestamp('2079-12-31 23:59:59.999999', 'YYYY-MM-DD HH24:MI:SS.US')) AND (temp_data.t_1512599834_6677622796.data_status = 'M')
enterprisedb-2017-12-06_171058.log-2017-12-06 17:37:21 EST [12089]: [1-1] user=,db=LOG:  automatic vacuum of table "data_warehouse.temp_data.t_1512599834_6677622796": index scans: 0
grep: temp_xlog: Is a directory

++++++++++++++++++++++++++++
#2017-12-07
overnight log detail files:
[enterprisedb@pg-prd1 pg_log]$ date
Thu Dec  7 08:08:36 EST 2017
[enterprisedb@pg-prd1 pg_log]$ find /var/pg_log -type f -mmin -600 -exec ls -ltr {} \;
-rw-------. 1 enterprisedb enterprisedb 10486799 Dec  6 23:08 /var/pg_log/enterprisedb-2017-12-06_215223.log
-rw-------. 1 enterprisedb enterprisedb 6648649 Dec  6 23:59 /var/pg_log/enterprisedb-2017-12-06_230843.log
-rw-------. 1 enterprisedb enterprisedb 10487305 Dec  7 01:45 /var/pg_log/enterprisedb-2017-12-07_000000.log
-rw-------. 1 enterprisedb enterprisedb 10486274 Dec  7 02:30 /var/pg_log/enterprisedb-2017-12-07_014548.log
-rw-------. 1 enterprisedb enterprisedb 10486687 Dec  7 02:30 /var/pg_log/enterprisedb-2017-12-07_023009.log
-rw-------. 1 enterprisedb enterprisedb 10486248 Dec  7 02:30 /var/pg_log/enterprisedb-2017-12-07_023017.log
-rw-------. 1 enterprisedb enterprisedb 10485876 Dec  7 02:30 /var/pg_log/enterprisedb-2017-12-07_023024.log
-rw-------. 1 enterprisedb enterprisedb 10486346 Dec  7 02:34 /var/pg_log/enterprisedb-2017-12-07_023035.log
-rw-------. 1 enterprisedb enterprisedb 10486232 Dec  7 02:55 /var/pg_log/enterprisedb-2017-12-07_023432.log
-rw-------. 1 enterprisedb enterprisedb 10486159 Dec  7 03:15 /var/pg_log/enterprisedb-2017-12-07_025515.log
-rw-------. 1 enterprisedb enterprisedb 10485824 Dec  7 03:26 /var/pg_log/enterprisedb-2017-12-07_031502.log
-rw-------. 1 enterprisedb enterprisedb 10486414 Dec  7 03:54 /var/pg_log/enterprisedb-2017-12-07_032607.log
-rw-------. 1 enterprisedb enterprisedb 10486291 Dec  7 04:23 /var/pg_log/enterprisedb-2017-12-07_035449.log
-rw-------. 1 enterprisedb enterprisedb 10485851 Dec  7 05:10 /var/pg_log/enterprisedb-2017-12-07_042326.log
-rw-------. 1 enterprisedb enterprisedb 10486155 Dec  7 05:50 /var/pg_log/enterprisedb-2017-12-07_051005.log
-rw-------. 1 enterprisedb enterprisedb 10485875 Dec  7 07:12 /var/pg_log/enterprisedb-2017-12-07_055017.log
-rw-------. 1 enterprisedb enterprisedb 8945878 Dec  7 08:08 /var/pg_log/enterprisedb-2017-12-07_071252.log

-- check "found unexpected null value in index" from 2017-12-06 9PM to this morning 
[enterprisedb@pg-prd1 pg_log]$ grep "unexpected" $(find /var/pg_log -type f -mmin -600 -exec ls  {} \;)
/var/pg_log/enterprisedb-2017-12-06_215223.log: 2017-12-06 17:37:16 EST [12056]: [1-1] user=postgres,db=data_warehouseERROR:  found unexpected null value in index "ix_t_1512599834_6677622796_key"
[enterprisedb@pg-prd1 pg_log]$
-- no error !!!
===========================
-- check UPDATE statement for condition : entity_master.perspective_entity_id_raw_v.perspective_entity_id_raw_key = temp_data.t"
[enterprisedb@pg-prd1 pg_log]$ grep "entity_master.perspective_entity_id_raw_v.perspective_entity_id_raw_key = temp_data.t" $(find /var/pg_log -type f -mmin -600 -exec ls    {} \;) -B 2 -A 2 > /tmp/pg-prd1_log_detail_troubleshooting.txt
-- did not find index null value in all of update operation from 2106-12-06 10PM to 2017-12-07 8AM 

[root@pg-prd1 efm-2.1]# cat efm.properties| grep -v \# | sed '/^\s*$/d'
efm.license=4008J-6GL6H-RB010-7S412-GCTFN
db.user=postgres
db.password.encrypted=22a85432353cbff0bb8b4cab6cd53045
db.port=5444
db.database=postgres
db.service.owner=enterprisedb
db.service.name=
db.bin=/usr/edb/as9.6/bin
db.recovery.conf.dir=/var/lib/edb/as9.6/data
jdbc.ssl=false
jdbc.ssl.mode=verify-ca
user.email=guorong.zhang@enterprisedb.com
script.notification=
bind.address=10.91.10.226:7809
admin.port=7800
is.witness=false
local.period=10
local.timeout=60
local.timeout.final=10
remote.timeout=10
node.timeout=50
pingServerIp=8.8.8.8
pingServerCommand=/bin/ping -q -c3 -w5
auto.allow.hosts=true
db.reuse.connection.count=0
auto.failover=false
auto.reconfigure=true
promotable=true
minimum.standbys=0
recovery.check.period=2
auto.resume.period=0
virtualIp=10.91.10.225
virtualIp.interface=ens192:0
virtualIp.netmask=255.255.255.0
script.fence=
script.post.promotion=
script.resumed=
script.db.failure=
script.master.isolated=
sudo.command=sudo
sudo.user.command=sudo -u %u
jgroups.loglevel=INFO
efm.loglevel=INFO
jvm.options=-Xmx32m
[root@pg-prd1 efm-2.1]#
===================
[root@pg-prd1 efm-2.1]# /usr/efm-2.1/bin/efm cluster-status efm
Cluster Status: efm
VIP: 10.91.10.225
Automatic failover is disabled.

        Agent Type  Address              Agent  DB       Info
        --------------------------------------------------------------
        Master      10.91.10.226         UP     UP

Allowed node host list:
        10.91.10.226 10.91.10.227 10.91.10.229

Membership coordinator: 10.91.10.226

Standby priority host list:
        (List is empty.)

Promote Status:

        DB Type     Address              XLog Loc         Info
        --------------------------------------------------------------
        Master      10.91.10.226         13A9/8E73D2B0

        No standby databases were found.

=========================
[root@pg-prd2 ~]# /usr/efm-2.1/bin/runefm.sh  start efm
[root@pg-prd2 ~]# /usr/efm-2.1/bin/efm cluster-status efm
Cluster Status: efm
VIP: 10.91.10.225
Automatic failover is disabled.

        Agent Type  Address              Agent  DB       Info
        --------------------------------------------------------------
        Master      10.91.10.226         UP     UP
        Standby     10.91.10.227         UP     UP

Allowed node host list:
        10.91.10.226 10.91.10.227 10.91.10.229

Membership coordinator: 10.91.10.226

Standby priority host list:
        10.91.10.227

Promote Status:

        DB Type     Address              XLog Loc         Info
        --------------------------------------------------------------
        Master      10.91.10.226         13AB/52C40958
        Standby     10.91.10.227         13AB/52DAB178

        One or more standby databases are not in sync with the master database.
      ================
      [root@pem-prd ~]# /usr/efm-2.1/bin/runefm.sh  start efm
[root@pem-prd ~]# /usr/efm-2.1/bin/efm cluster-status efm
Cluster Status: efm
VIP: 10.91.10.225
Automatic failover is disabled.

        Agent Type  Address              Agent  DB       Info
        --------------------------------------------------------------
        Master      10.91.10.226         UP     UP
        Witness     10.91.10.229         UP     N/A
        Standby     10.91.10.227         UP     UP

Allowed node host list:
        10.91.10.226 10.91.10.227 10.91.10.229

Membership coordinator: 10.91.10.226

Standby priority host list:
        10.91.10.227

Promote Status:

        DB Type     Address              XLog Loc         Info
        --------------------------------------------------------------
        Master      10.91.10.226         13AC/5EA90100
        Standby     10.91.10.227         13AC/5EAC9FF0

        One or more standby databases are not in sync with the master database.
[root@pem-prd ~]#
[root@pem-prd ~]# /usr/efm-2.1/bin/efm cluster-status efm| grep "Allowed node host list" -A 1
Allowed node host list:
        10.91.10.226 10.91.10.227 10.91.10.229

 -----------------------------
 -- check how fast wal transfer from pg-prd1 to pg-dr
 
 [enterprisedb@pg-dr pg_log]$ pwd
/var/pg_log
[enterprisedb@pg-dr pg_log]$ tail -n 200  enterprisedb-2017-12-07_105932.log| grep archive
2017-12-07 14:46:36 EST [24481]: [18163-1] user=,db=LOG:  restored log file "00000001000013DC00000072" from archive
2017-12-07 14:46:37 EST [24481]: [18164-1] user=,db=LOG:  restored log file "00000001000013DC00000073" from archive
2017-12-07 14:46:38 EST [24481]: [18165-1] user=,db=LOG:  restored log file "00000001000013DC00000074" from archive
2017-12-07 14:46:38 EST [24481]: [18166-1] user=,db=LOG:  restored log file "00000001000013DC00000075" from archive
2017-12-07 14:46:39 EST [24481]: [18167-1] user=,db=LOG:  restored log file "00000001000013DC00000076" from archive
2017-12-07 14:46:39 EST [24481]: [18168-1] user=,db=LOG:  restored log file "00000001000013DC00000077" from archive
2017-12-07 14:46:40 EST [24481]: [18169-1] user=,db=LOG:  restored log file "00000001000013DC00000078" from archive
2017-12-07 14:46:41 EST [24481]: [18170-1] user=,db=LOG:  restored log file "00000001000013DC00000079" from archive
2017-12-07 14:46:42 EST [24481]: [18171-1] user=,db=LOG:  restored log file "00000001000013DC0000007A" from archive
2017-12-07 14:46:42 EST [24481]: [18172-1] user=,db=LOG:  restored log file "00000001000013DC0000007B" from archive
2017-12-07 14:46:43 EST [24481]: [18173-1] user=,db=LOG:  restored log file "00000001000013DC0000007C" from archive
2017-12-07 14:46:44 EST [24481]: [18174-1] user=,db=LOG:  restored log file "00000001000013DC0000007D" from archive
2017-12-07 14:46:44 EST [24481]: [18175-1] user=,db=LOG:  restored log file "00000001000013DC0000007E" from archive
2017-12-07 14:46:48 EST [24481]: [18176-1] user=,db=LOG:  restored log file "00000001000013DC0000007F" from archive
2017-12-07 14:46:49 EST [24481]: [18177-1] user=,db=LOG:  restored log file "00000001000013DC00000080" from archive
2017-12-07 14:46:50 EST [24481]: [18178-1] user=,db=LOG:  restored log file "00000001000013DC00000081" from archive
2017-12-07 14:46:51 EST [24481]: [18179-1] user=,db=LOG:  restored log file "00000001000013DC00000082" from archive
2017-12-07 14:46:52 EST [24481]: [18180-1] user=,db=LOG:  restored log file "00000001000013DC00000083" from archive
2017-12-07 14:46:52 EST [24481]: [18181-1] user=,db=LOG:  restored log file "00000001000013DC00000084" from archive
2017-12-07 14:46:53 EST [24481]: [18182-1] user=,db=LOG:  restored log file "00000001000013DC00000085" from archive
2017-12-07 14:46:54 EST [24481]: [18183-1] user=,db=LOG:  restored log file "00000001000013DC00000086" from archive
2017-12-07 14:46:54 EST [24481]: [18184-1] user=,db=LOG:  restored log file "00000001000013DC00000087" from archive
2017-12-07 14:46:55 EST [24481]: [18185-1] user=,db=LOG:  restored log file "00000001000013DC00000088" from archive
2017-12-07 14:46:55 EST [24481]: [18186-1] user=,db=LOG:  restored log file "00000001000013DC00000089" from archive
2017-12-07 14:46:56 EST [24481]: [18187-1] user=,db=LOG:  restored log file "00000001000013DC0000008A" from archive
2017-12-07 14:46:57 EST [24481]: [18188-1] user=,db=LOG:  restored log file "00000001000013DC0000008B" from archive
2017-12-07 14:46:57 EST [24481]: [18189-1] user=,db=LOG:  restored log file "00000001000013DC0000008C" from archive
2017-12-07 14:46:58 EST [24481]: [18190-1] user=,db=LOG:  restored log file "00000001000013DC0000008D" from archive
2017-12-07 14:46:59 EST [24481]: [18191-1] user=,db=LOG:  restored log file "00000001000013DC0000008E" from archive
[enterprisedb@pg-dr pg_log]$

28 WAL file are scped from pg-prd1 to pg-dr with 24 seconds 

transfer speed = 28 file X 16MB /24 seconds X 60 = 1120 MB /miunte = 1GB /minutes 

=================
bart config file bart.cfg
[BART]
bart_host= enterprisedb@127.0.0.1
backup_path = /backup
pg_basebackup_path = /usr/edb/as9.6/bin/pg_basebackup
logfile = /tmp/bart.log
scanner_logfile = /tmp/bart_scanner.log


[PGPRDAS96]
host = 10.91.10.226
port = 5444
user = bartuser
cluster_owner = enterprisedb
backup_name = pg-prd1_%year-%month-%dayT%hour:%minute:%second
retention_policy = 7 DAYS
#archive_command = 'cp %p %a/%f'
allow_incremental_backups = enabled
description = "PG_PRD1 EPAS 96 server"
[root@pg-prd1 etc]#
======================
-- bart pg_hba.conf setup must connect to template1 
host    template1       bartuser        127.0.0.1/32             md5
host    template1       bartuser        10.91.10.226/32          md5
host    all             bartuser        10.91.10.226/32          md5

==============================================
for bart, enable archive_command :

archive_command = 'cp %p /backup/pgprdas96/archived_wals/%f'
======================
.pgpass for bartuser :
127.0.0.1:5444:*:bartuser:bartuser
10.91.10.226:5444:*:bartuser:bartuser

========================
check bart server 
[enterprisedb@pg-prd1 ~]$ bart show-servers  -s pgprdas96
SERVER NAME         : pgprdas96
BACKUP FRIENDLY NAME: pg-prd1_%year-%month-%dayT%hour:%minute:%second
HOST NAME           : 10.91.10.226
USER NAME           : bartuser
PORT                : 5444
REMOTE HOST         :
RETENTION POLICY    : 2017-11-30 17:25:28 EST
DISK UTILIZATION    : 616.52 GB
NUMBER OF ARCHIVES  : 0
ARCHIVE PATH        : /backup/pgprdas96/archived_wals
ARCHIVE COMMAND     : cp %p /backup/pgprdas96/archived_wals/%f
XLOG METHOD         : fetch
WAL COMPRESSION     : disabled
TABLESPACE PATH(s)  :
INCREMENTAL BACKUP  : ENABLED
DESCRIPTION         : "PG_PRD1 EPAS 96 server"
=================

[enterprisedb@pg-prd1 ~]$ bart-scanner --daemon
[enterprisedb@pg-prd1 ~]$

-- full backup 
[enterprisedb@pg-prd1 ~]$ bart backup -s pgprdas96  --backup-name pgprdas96_full_parent
INFO:  creating backup for server 'pgprdas96'
INFO:  backup identifier: '1512686558705'
  14053844/1112120706 kB (1%), 0/1 tablespace

command failed with exit code 1
pg_basebackup: could not get transaction log end position from server: ERROR:  requested WAL segment 00000001000013EC000000C5 has already been removed
-- set wal_keep_segments:

postgres=# show wal_keep_segments;
 wal_keep_segments
-------------------
 2000
(1 row)

-- re try bart full backup 
[enterprisedb@pg-prd1 ~]$ bart backup -s pgprdas96  --backup-name pgprdas96_full_parent
......
-- this time is done with no error.
\[enterprisedb@pg-prd1 tmp]$ \cat fullbk.log
INFO:  creating backup for server 'pgprdas96'
INFO:  backup identifier: '1512690649408'
1112305759/1112305759 kB (100%), 1/1 tablespace

INFO:  backup completed successfully
INFO:  backup checksum: 2dfa63b0b0b46854814a810cea1b9582 of base.tar
INFO:
BACKUP DETAILS:
BACKUP STATUS: active
BACKUP IDENTIFIER: 1512690649408
BACKUP NAME: pgprdas96_full_parent
BACKUP PARENT: none
BACKUP LOCATION: /backup/pgprdas96/1512690649408
BACKUP SIZE: 1.04 TB
BACKUP FORMAT: tar
BACKUP TIMEZONE: US/Eastern
XLOG METHOD: fetch
BACKUP CHECKSUM(s): 1
 ChkSum                             File
 2dfa63b0b0b46854814a810cea1b9582   base.tar

TABLESPACE(s): 0
START WAL LOCATION: 00000001000013EC000000CF
STOP WAL LOCATION: 00000001000013EC000000D9
BACKUP METHOD: streamed
BACKUP FROM: master
START TIME: 2017-12-07 18:50:50 EST
STOP TIME: 2017-12-07 19:47:50 EST
TOTAL DURATION: 57 min(s)

[enterprisedb@pg-prd1 tmp]$

-- check bart backup 

[enterprisedb@pg-prd1 ~]$ bart show-backups -s pgprdas96
 SERVER NAME   BACKUP ID       BACKUP NAME             BACKUP PARENT   BACKUP TIME               BACKUP SIZE   WAL(s) SIZE   WAL FILES   STATUS

 pgprdas96     1512690649408   pgprdas96_full_parent   none            2017-12-07 19:48:06 EST   1.04 TB       1.88 GB       120         active

[enterprisedb@pg-prd1 ~]$

--- incrementaql bart backup 
-- bart-scanner --daemon already started 

incrtime=$(date +%y%m%d%H%M)
bart BACKUP -s pgprdas96 -F p --parent pgprdas96_full_parent --backup-name pgprdas96_incr_$incrtime

[enterprisedb@pg-prd1 ~]$ bart BACKUP -s pgprdas96 -F p --parent pgprdas96_full_parent --backup-name pgprdas96_incr_$(date +%y%m%d%H%M)
INFO:  creating incremental backup for server 'pgprdas96'
INFO:  checking mbm files /backup/pgprdas96/archived_wals
INFO:  new backup identifier generated 1512698646329
The authenticity of host '10.91.10.226 (10.91.10.226)' can't be established.
ECDSA key fingerprint is SHA256:fuIqwb05GobZCz6OSEK3Ie7IWL6N82MS4huuxoZcfBw.
ECDSA key fingerprint is MD5:c5:f1:bd:8c:4c:5b:fe:c6:ff:29:95:f6:83:0c:2e:3c.
Are you sure you want to continue connecting (yes/no)? yes
INFO:  reading directory /backup/pgprdas96/archived_wals
INFO:  all files processed
NOTICE:  pg_stop_backup complete, all required WAL segments have been archived
INFO:  incremental backup completed successfully
INFO:
BACKUP DETAILS:
BACKUP STATUS: active
BACKUP IDENTIFIER: 1512698646329
BACKUP NAME: pgprdas96_incr_1712072101
BACKUP PARENT: 1512690649408
BACKUP LOCATION: /backup/pgprdas96/1512698646329
BACKUP SIZE: 2.21 GB
BACKUP FORMAT: plain
BACKUP TIMEZONE: US/Eastern
XLOG METHOD: fetch
BACKUP CHECKSUM(s): 0
TABLESPACE(s): 0
START WAL LOCATION: 00000001000013ED0000004A
STOP WAL LOCATION: 00000001000013ED0000004B
BACKUP METHOD: pg_start_backup
BACKUP FROM: master
START TIME: 2017-12-07 21:04:39 EST
STOP TIME: 2017-12-07 21:07:17 EST
TOTAL DURATION: 2.63333 min(s)

[enterprisedb@pg-prd1 ~]$
-- show backups
[enterprisedb@pg-prd1 pgprdas96]$ bart show-backups;
 SERVER NAME   BACKUP ID       BACKUP NAME                 BACKUP PARENT           BACKUP TIME               BACKUP SIZE   WAL(s) SIZE   WAL FILES   STATUS

 pgprdas96     1512699086214   pgprdas96_incr_1712072111   pgprdas96_full_parent   2017-12-07 21:11:28 EST   2.21 GB                                 active
 pgprdas96     1512698646329   pgprdas96_incr_1712072101   pgprdas96_full_parent   2017-12-07 21:05:21 EST   2.21 GB                                 active
 pgprdas96     1512690649408   pgprdas96_full_parent       none                    2017-12-07 19:48:06 EST   1.04 TB       2.98 GB       191         active

[enterprisedb@pg-prd1 pgprdas96]$
==================
2017-12-08
set pem email group 
stmp server :
See the server names below requested to setups SMTP from PEM. 
 
Dr -> qsi-njdc-exca
 
Prd -> qsi-nydc-exca


PEM sender's email: postgres_moitor@qsinvestors.com
PEM reciever email: Technology@qsinvestors.com 
--- re do incremental backup ( always based on full pratent backup)

[enterprisedb@pg-prd1 pgprdas96]$ bart show-backups
 SERVER NAME   BACKUP ID       BACKUP NAME                 BACKUP PARENT           BACKUP TIME               BACKUP SIZE   WAL(s) SIZE   WAL FILES   STATUS

 pgprdas96     1512746529495   pgprdas96_incr_1712081022   pgprdas96_full_parent   2017-12-08 10:22:14 EST   218.08 GB                               active
 pgprdas96     1512699086214   pgprdas96_incr_1712072111   pgprdas96_full_parent   2017-12-07 21:11:28 EST   2.21 GB                                 active
 pgprdas96     1512698646329   pgprdas96_incr_1712072101   pgprdas96_full_parent   2017-12-07 21:05:21 EST   2.21 GB                                 active
 pgprdas96     1512690649408   pgprdas96_full_parent       none                    2017-12-07 19:48:06 EST   1.04 TB       725.86 GB     46455       active


